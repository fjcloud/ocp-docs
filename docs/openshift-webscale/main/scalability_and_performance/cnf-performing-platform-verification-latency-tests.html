

<!DOCTYPE html>
<!--[if IE 8]> <html class="ie8"> <![endif]-->
<!--[if IE 9]> <html class="ie9"> <![endif]-->
<!--[if gt IE 9]><!-->
<html>
<!--<![endif]-->

<head>
  <meta charset="utf-8">
  <meta content="IE=edge" http-equiv="X-UA-Compatible">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <meta name="robots" content="noindex,nofollow">
  
  
  <title>Performing latency tests for platform verification | Scalability and performance | OpenShift Container Platform Branch Build</title>
  <link href="https://assets.openshift.net/content/subdomain.css" rel="stylesheet" type="text/css"/>
  <link href="https://docs.okd.io/latest/_stylesheets/search.css" rel="stylesheet" media="screen"/>
  <link href="https://docs.okd.io/latest/_stylesheets/autumn.css" rel="stylesheet"  media="screen"/>
  <link href="https://assets.openshift.net/content/subdomain/touch-icon-precomposed.png" rel="apple-touch-icon-precomposed" type="image/png"/>
  <link href="https://assets.openshift.net/content/subdomain/favicon32x32.png" rel="shortcut icon" type="text/css"/>
  <link href="https://assets.openshift.net/content/osh-nav-footer.css" rel="stylesheet" type="text/css" media="screen"/>
  <link href="https://docs.okd.io/latest/_stylesheets/docs.css" rel="stylesheet"  media="screen"/>
  <link href="https://docs.okd.io/latest/_stylesheets/print.css" rel="stylesheet" type="text/css" media="print"/>
  <!--[if IE]><link rel="shortcut icon" href="https://assets.openshift.net/content/subdomain/favicon.ico"><![endif]-->
  <!-- or, set /favicon.ico for IE10 win -->
  <meta content="OpenShift" name="application-name">
  <meta content="#000000" name="msapplication-TileColor">
  <meta content="https://assets.openshift.net/content/subdomain/touch-icon-precomposed.png" name="msapplication-TileImage">

  <!-- Adobe DTM -->
  <script src="//www.redhat.com/dtm.js" type="text/javascript"></script>
  <!-- End Adobe DTM -->

  <script id="trustarc" src="https://static.redhat.com/libs/redhat/marketing/latest/trustarc/trustarc.js"></script>

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined"
        rel="stylesheet">

</head>

<body onload="selectVersion('Branch Build');">
  
<nav id="main">
  <div class="container">
    <div class="row">
      <div class="navbar navbar-default navbar-openshift" role="navigation">
        <div class="navbar-header">
            <a href="#nav-main" class="dropdown-toggle navbar-menu-toggle hidden visible-xs" data-toggle="collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </a>
          <a class="navbar-brand" href="/"></a>
        </div>
        <div id="nav-main" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li id="products" class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-expanded="true">
                Products <span class="fa fa-angle-down"></span>
              </a>
              <div class="dropdown-menu">
                <div class="row flex-column flex-md-row">
                  <div class="col-xs-12 col-sm-3">
                    <h3>Overview</h3>
                    <ul class="nav flex-column">
                      <li><a target="_blank" href="https://www.openshift.com/products/features/">Features</a></li>
                      <li><a target="_blank" href="https://www.openshift.com/products/pricing/">Pricing</a></li>
                    </ul>
                  </div>
                  <div class="col-xs-12 col-sm-9">
                    <h3>Featured Products</h3>
                    <ul class="nav">
                      <li>
                        <a target="_blank" href="https://www.openshift.com/products/container-platform/">Red Hat OpenShift Container&nbsp;Platform</a>
                        <p class="d-none d-md-block">Build, deploy and manage your applications across cloud- and on-premise infrastructure</p>
                      </li>
                      <li>
                        <a target="_blank" href="https://www.openshift.com/products/dedicated/">Red Hat OpenShift Dedicated</a>
                        <p class="d-none d-md-block">Single-tenant, high-availability Kubernetes clusters in the public cloud</p>
                      </li>

                      <li>
                        <a target="_blank" href="https://www.openshift.com/products/online/">Red Hat OpenShift Online</a>
                        <p class="d-none d-md-block">The fastest way for developers to build, host and scale applications in the public cloud</p>
                      </li>

                      <li class="nav-item">
                        <a target="_blank" href="https://www.openshift.com/products/">All products <span class="fa fa-angle-right"></span></a>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </li>

            <li id="learn" class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                Learn <span class="fa fa-angle-down"></span>
              </a>
              <div class="dropdown-menu">
                <div class="row flex-md-nowrap">
                  <div class="col-xs-12 col-sm-6">
                    <h3>Learn</h3>
                    <ul class="nav">
                      <li><a target="_blank" href="https://www.openshift.com/learn/what-is-openshift/">What is OpenShift</a></li>
                      <li><a target="_blank" href="https://www.openshift.com/learn/get-started/">Get started</a></li>
                      <li><a target="_blank" href="https://www.openshift.com/learn/partners/">Partners</a></li>
                      <li><a target="_blank" href="https://www.openshift.com/learn/success-stories/">Customer success stories</a></li>
                      <li><a target="_blank" href="https://blog.openshift.com">Blog</a></li>
                      <li><a target="_blank" href="https://www.openshift.com/learn/resources/">Resources</a></li>
                    </ul>
                  </div>
                  <div class="col-xs-12 col-sm-6">
                    <h3>Technology Topics</h3>
                    <ul class="nav">
                      <li><a target="_blank" href="https://www.openshift.com/learn/topics/knative/">Knative</a></li>
                      <li><a target="_blank" href="https://www.openshift.com/learn/topics/security/">Security</a></li>
                      <li><a target="_blank" href="https://www.openshift.com/learn/topics/kubernetes/">Kubernetes</a></li>
                      <li><a target="_blank" href="https://www.openshift.com/learn/topics/service-brokers/">Service Brokers</a></li>
                    </ul>
                  </div>
                </div>
              </div>
            </li>

            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                Community <span class="fa fa-angle-down"></span>
              </a>
              <ul class="dropdown-menu">
                <li><a target="_blank" href="https://commons.openshift.org">OpenShift Commons</a></li>
                <li><a target="_blank" href="https://www.okd.io">Open Source (OKD)</a></li>
                <li><a target="_blank" href="https://www.openshift.com/community/programs/startups/">Startups</a></li>
                <li><a target="_blank" href="https://www.openshift.com/community/programs/grants/">Grants</a></li>
              </ul>
            </li>

            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                Support <span class="fa fa-angle-down"></span>
              </a>
              <ul class="dropdown-menu">
                <li><a target="_blank" href="https://help.openshift.com">Help Center</a></li>
                <li><a href="https://docs.openshift.com">OpenShift Docs</a></li>
              </ul>
            </li>

            <li><a target="_blank" class="nav-sign-up" href="https://www.openshift.com/trial/">Free Trial</a></li>

            <li><a target="_blank" href="https://console.redhat.com/openshift" class="nav-sign-in">Log In <span class="fa fa-angle-right"></span></a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</nav>

  
  <div class="container">
    <button id="hc-open-btn" class="open-btn-sm" onclick="openNav()" aria-label="Open"><span class="fa fa-bars" /></button>
    <ol class="breadcrumb hide-for-print">
      

      
      <span>
        <div class="alert alert-danger" role="alert" id="support-alert">
          <strong>This documentation is work in progress and might not be complete or fully tested.</strong> The latest supported version of version 3 is <a href="https://docs.openshift.com/container-platform/3.11/welcome/index.html" class="link-primary" style="color: #545454 !important;">[3.11]</a>. For the most recent version 4, see <a href="https://docs.openshift.com/container-platform/latest/welcome/index.html" style="color: #545454 !important" class="link-primary">[4]</a>.
        </div>
      </span>
      

      

      

      

      

      

      
      

      

      


      

      


      

      

      <li class="sitename">
        <a href="/">
          Documentation</a>
      </li>
      <li class="hidden-xs active">
        
          <a href="../welcome/index.html">OpenShift Container Platform Branch Build</a>
        
      </li>
      <li class="hidden-xs active">
        <a href="../scalability_and_performance/index.html">Scalability and performance</a>
      </li>
      
      
      <li class="hidden-xs active">
        Performing latency tests for platform verification
      </li>
      
      <span text-align="right" style="float: right !important">
        <a href="https://github.com/openshift/openshift-docs/commits/main/scalability_and_performance/cnf-performing-platform-verification-latency-tests.adoc"><span class="material-icons-outlined" title="Page history">history</span></a>
        
        <a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12332330&issuetype=1&components=12367614&priority=4&summary=Issue+in+file+scalability_and_performance/cnf-performing-platform-verification-latency-tests.adoc">
          <span class="material-icons-outlined" title="Open an issue">bug_report</span>
        </a>
        <a href="javascript: void(0);" onclick="window.print()"><span class="material-icons-outlined" title="Print page (Save as PDF)">picture_as_pdf</span></a>
        
        
      </span>
      
    </ol>
    <div class="row row-offcanvas row-offcanvas-left">
      <div class="col-xs-8 col-sm-3 col-md-3 sidebar sidebar-offcanvas hide-for-print">
        <div class="row-fluid">
          <div id="btn-close">
            <button id="hc-close-btn" onclick="closeNav()" class="close-btn-sm" aria-label="close"><span class="fa fa-times" /></button>
          </div>
          <div id="hc-search">
            <input id="hc-search-input" type="text" aria-label="search">
            <button id="hc-search-btn" aria-label="search"><span class="fa fa-search" /></button>
          </div>
        </div>
        <ul class="nav nav-sidebar">
    <li class="nav-header"><a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicGroup0"><span id="tgSpan0" class="fa fa-angle-right"></span>About</a>
      <ul id="topicGroup0" class="collapse  list-unstyled">
            <li><a class="" href="../welcome/index.html">Welcome</a></li>
            <li><a class="" href="../welcome/learn_more_about_openshift.html">Learn more about OpenShift Container Platform</a></li>
      </ul>
    </li>
    <li class="nav-header"><a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicGroup1"><span id="tgSpan1" class="fa fa-angle-down"></span>Scalability and performance</a>
      <ul id="topicGroup1" class="collapse in list-unstyled">
            <li><a class="" href="../scalability_and_performance/index.html">Scalability and performance overview</a></li>
            <li><a class="" href="../scalability_and_performance/telco-core-rds.html">Telco core reference design specifications</a></li>
            <li><a class="" href="../scalability_and_performance/telco-ran-du-rds.html">Telco RAN DU reference design specifications</a></li>
            <li><a class="" href="../scalability_and_performance/compute-resource-quotas.html">Compute Resource Quotas</a></li>
            <li><a class="" href="../scalability_and_performance/cnf-understanding-low-latency.html">Understanding low latency</a></li>
            <li><a class="" href="../scalability_and_performance/cnf-tuning-low-latency-nodes-with-perf-profile.html">Tuning nodes for low latency with the performance profile</a></li>
            <li><a class="" href="../scalability_and_performance/cnf-provisioning-low-latency-workloads.html">Provisioning real-time and low latency workloads</a></li>
            <li><a class="" href="../scalability_and_performance/cnf-debugging-low-latency-tuning-status.html">Debugging low latency tuning</a></li>
            <li><a class=" active" href="../scalability_and_performance/cnf-performing-platform-verification-latency-tests.html">Performing latency tests for platform verification</a></li>
      </ul>
    </li>
</ul>
      </div>
      <div id="hc-search-modal">
        <div id="hc-modal-content">
          <span id="hc-modal-close">&times;</span>
          <div id="hc-search-results-wrapper">
            <div id="hc-search-results"></div>
            <div id="hc-search-progress-indicator" class="text-center search-progress-indicator"><i class="fa fa-circle-o-notch fa-spin" style="font-size:42px"></i></div>
            <div class="text-center">
              <button id="hc-search-more-btn">Show more results</button>
            </div>
          </div>
        </div>
      </div>
      <div class="print-logo" style="display:none;">
        <img src="https://www.redhat.com/cms/managed-files/Logo-Red_Hat-OpenShift-A-Standard-RGB_0_0.svg" alt="print logo"/>
      </div>
      <div class="col-xs-12 col-sm-9 col-md-9 main">
        <div class="page-header">
          <h1>
            Performing latency tests for platform verification
          </h1>
        </div>
        
        
        <div id="preamble">
<div class="sectionbody">
<div id="toc" class="toc">
<div id="toctitle" class="title"></div>
<ul class="sectlevel1">
<li><a href="#cnf-latency-tests-prerequisites_cnf-latency-tests">Prerequisites for running latency tests</a></li>
<li><a href="#cnf-measuring-latency_cnf-latency-tests">Measuring latency</a></li>
<li><a href="#cnf-performing-end-to-end-tests-running-the-tests_cnf-latency-tests">Running the latency tests</a>
<ul class="sectlevel2">
<li><a href="#cnf-performing-end-to-end-tests-running-hwlatdetect_cnf-latency-tests">Running hwlatdetect</a></li>
<li><a href="#cnf-performing-end-to-end-tests-running-cyclictest_cnf-latency-tests">Running cyclictest</a></li>
<li><a href="#cnf-performing-end-to-end-tests-running-oslat_cnf-latency-tests">Running oslat</a></li>
</ul>
</li>
<li><a href="#cnf-performing-end-to-end-tests-test-failure-report_cnf-latency-tests">Generating a latency test failure report</a></li>
<li><a href="#cnf-performing-end-to-end-tests-junit-test-output_cnf-latency-tests">Generating a JUnit latency test report</a></li>
<li><a href="#cnf-performing-end-to-end-tests-running-in-single-node-cluster_cnf-latency-tests">Running latency tests on a single-node OpenShift cluster</a></li>
<li><a href="#cnf-performing-end-to-end-tests-disconnected-mode_cnf-latency-tests">Running latency tests in a disconnected cluster</a></li>
<li><a href="#cnf-performing-end-to-end-tests-troubleshooting_cnf-latency-tests">Troubleshooting errors with the cnf-tests container</a></li>
</ul>
</div>
<div class="paragraph">
<p>You can use the Cloud-native Network Functions (CNF) tests image to run latency tests on a CNF-enabled OpenShift Container Platform cluster, where all the components required for running CNF workloads are installed. Run the latency tests to validate node tuning for your workload.</p>
</div>
<div class="paragraph">
<p>The <code>cnf-tests</code> container image is available at <code>registry.redhat.io/openshift4/cnf-tests-rhel8:vBranch Build</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cnf-latency-tests-prerequisites_cnf-latency-tests"><a class="anchor" href="#cnf-latency-tests-prerequisites_cnf-latency-tests"></a>Prerequisites for running latency tests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Your cluster must meet the following requirements before you can run the latency tests:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You have applied all the required CNF configurations. This includes the <code>PerformanceProfile</code> cluster and other configuration according to the reference design specifications (RDS) or your specific requirements.</p>
</li>
<li>
<p>You have logged in to <code>registry.redhat.io</code> with your Customer Portal credentials by using the <code>podman login</code> command.</p>
</li>
</ul>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="../scalability_and_performance/cnf-provisioning-low-latency-workloads.html#cnf-scheduling-workload-onto-worker-with-real-time-capabilities_cnf-provisioning-low-latency">Scheduling a workload onto a worker with real-time capabilities</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cnf-measuring-latency_cnf-latency-tests"><a class="anchor" href="#cnf-measuring-latency_cnf-latency-tests"></a>Measuring latency</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>cnf-tests</code> image uses three tools to measure the latency of the system:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>hwlatdetect</code></p>
</li>
<li>
<p><code>cyclictest</code></p>
</li>
<li>
<p><code>oslat</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each tool has a specific use. Use the tools in sequence to achieve reliable test results.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">hwlatdetect</dt>
<dd>
<p>Measures the baseline that the bare-metal hardware can achieve. Before proceeding with the next latency test, ensure that the latency reported by <code>hwlatdetect</code> meets the required threshold because you cannot fix hardware latency spikes by operating system tuning.</p>
</dd>
<dt class="hdlist1">cyclictest</dt>
<dd>
<p>Verifies the real-time kernel scheduler latency after <code>hwlatdetect</code> passes validation. The <code>cyclictest</code> tool schedules a repeated timer and measures the difference between the desired and the actual trigger times. The difference can uncover basic issues with the tuning caused by interrupts or process priorities. The tool must run on a real-time kernel.</p>
</dd>
<dt class="hdlist1">oslat</dt>
<dd>
<p>Behaves similarly to a CPU-intensive DPDK application and measures all the interruptions and disruptions to the busy loop that simulates CPU heavy data processing.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The tests introduce the following environment variables:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Latency test environment variables</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Environment variables</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LATENCY_TEST_DELAY</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specifies the amount of time in seconds after which the test starts running. You can use the variable to allow the CPU manager reconcile loop to update the default CPU pool. The default value is 0.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LATENCY_TEST_CPUS</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specifies the number of CPUs that the pod running the latency tests uses. If you do not set the variable, the default configuration includes all isolated CPUs.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LATENCY_TEST_RUNTIME</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specifies the amount of time in seconds that the latency test must run. The default value is 300 seconds.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To prevent the Ginkgo 2.0 test suite from timing out before the latency tests complete, set the <code>-ginkgo.timeout</code> flag to a value greater than <code>LATENCY_TEST_RUNTIME</code> + 2 minutes. If you also set a <code>LATENCY_TEST_DELAY</code> value then you must set <code>-ginkgo.timeout</code> to a value greater than <code>LATENCY_TEST_RUNTIME</code> + <code>LATENCY_TEST_DELAY</code> + 2 minutes. The default timeout value for the Ginkgo 2.0 test suite is 1 hour.</p>
</div>
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>HWLATDETECT_MAXIMUM_LATENCY</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specifies the maximum acceptable hardware latency in microseconds for the workload and operating system. If you do not set the value of <code>HWLATDETECT_MAXIMUM_LATENCY</code> or <code>MAXIMUM_LATENCY</code>, the tool compares the default expected threshold (20μs) and the actual maximum latency in the tool itself. Then, the test fails or succeeds accordingly.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CYCLICTEST_MAXIMUM_LATENCY</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specifies the maximum latency in microseconds that all threads expect before waking up during the <code>cyclictest</code> run. If you do not set the value of <code>CYCLICTEST_MAXIMUM_LATENCY</code> or <code>MAXIMUM_LATENCY</code>, the tool skips the comparison of the expected and the actual maximum latency.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OSLAT_MAXIMUM_LATENCY</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specifies the maximum acceptable latency in microseconds for the <code>oslat</code> test results. If you do not set the value of <code>OSLAT_MAXIMUM_LATENCY</code> or <code>MAXIMUM_LATENCY</code>, the tool skips the comparison of the expected and the actual maximum latency.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MAXIMUM_LATENCY</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Unified variable that specifies the maximum acceptable latency in microseconds. Applicable for all available latency tools.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Variables that are specific to a latency tool take precedence over unified variables. For example, if <code>OSLAT_MAXIMUM_LATENCY</code> is set to 30 microseconds and <code>MAXIMUM_LATENCY</code> is set to 10 microseconds, the <code>oslat</code> test will run with maximum acceptable latency of 30 microseconds.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cnf-performing-end-to-end-tests-running-the-tests_cnf-latency-tests"><a class="anchor" href="#cnf-performing-end-to-end-tests-running-the-tests_cnf-latency-tests"></a>Running the latency tests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Run the cluster latency tests to validate node tuning for your Cloud-native Network Functions (CNF) workload.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When executing <code>podman</code> commands as a non-root or non-privileged user, mounting paths can fail with <code>permission denied</code> errors. Depending on your local operating system and SELinux configuration, you might also experience issues running these commands from your home directory. To make the <code>podman</code> commands work, run the commands from a folder that is not your home/&lt;username&gt; directory, and append <code>:Z</code> to the volumes creation. For example, <code>-v $(pwd)/:/kubeconfig:Z</code>. This allows <code>podman</code> to do the proper SELinux relabeling.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This procedure runs the three individual tests <code>hwlatdetect</code>, <code>cyclictest</code>, and <code>oslat</code>. For details on these individual tests, see their individual sections.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open a shell prompt in the directory containing the <code>kubeconfig</code> file.</p>
<div class="paragraph">
<p>You provide the test image with a <code>kubeconfig</code> file in current directory and its related <code>$KUBECONFIG</code> environment variable, mounted through a volume. This allows the running container to use the <code>kubeconfig</code> file from inside the container.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In the following command, your local <code>kubeconfig</code> is mounted to kubeconfig/kubeconfig in the cnf-tests container, which allows access to the cluster.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>To run the latency tests, run the following command, substituting variable values as appropriate:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>podman run <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/:/kubeconfig:Z <span class="nt">-e</span> <span class="nv">KUBECONFIG</span><span class="o">=</span>/kubeconfig/kubeconfig <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">LATENCY_TEST_RUNTIME</span><span class="o">=</span>600<span class="se">\</span>
<span class="nt">-e</span> <span class="nv">MAXIMUM_LATENCY</span><span class="o">=</span>20 <span class="se">\</span>
registry.redhat.io/openshift4/cnf-tests-rhel8:vBranch Build /usr/bin/test-run.sh <span class="se">\</span>
<span class="nt">--ginkgo</span>.v <span class="nt">--ginkgo</span>.timeout<span class="o">=</span><span class="s2">"24h"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The LATENCY_TEST_RUNTIME is shown in seconds, in this case 600 seconds (10 minutes). The test runs successfully when the maximum observed latency is lower than MAXIMUM_LATENCY (20 μs).</p>
</div>
<div class="paragraph">
<p>If the results exceed the latency threshold, the test fails.</p>
</div>
</li>
<li>
<p>Optional: Append <code>--ginkgo.dry-run</code> flag to run the latency tests in dry-run mode. This is useful for checking what commands the tests run.</p>
</li>
<li>
<p>Optional: Append <code>--ginkgo.v</code> flag to run the tests with increased verbosity.</p>
</li>
<li>
<p>Optional: Append <code>--ginkgo.timeout="24h"</code> flag to ensure the Ginkgo 2.0 test suite does not timeout before the latency tests complete.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>During testing shorter time periods, as shown, can be used to run the tests. However, for final verification and valid results, the test should run for at least 12 hours (43200 seconds).</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="cnf-performing-end-to-end-tests-running-hwlatdetect_cnf-latency-tests"><a class="anchor" href="#cnf-performing-end-to-end-tests-running-hwlatdetect_cnf-latency-tests"></a>Running hwlatdetect</h3>
<div class="paragraph">
<p>The <code>hwlatdetect</code> tool is available in the <code>rt-kernel</code> package with a regular subscription of Red Hat Enterprise Linux (RHEL) 9.x.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When executing <code>podman</code> commands as a non-root or non-privileged user, mounting paths can fail with <code>permission denied</code> errors. Depending on your local operating system and SELinux configuration, you might also experience issues running these commands from your home directory. To make the <code>podman</code> commands work, run the commands from a folder that is not your home/&lt;username&gt; directory, and append <code>:Z</code> to the volumes creation. For example, <code>-v $(pwd)/:/kubeconfig:Z</code>. This allows <code>podman</code> to do the proper SELinux relabeling.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have reviewed the prerequisites for running latency tests.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>To run the <code>hwlatdetect</code> tests, run the following command, substituting variable values as appropriate:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>podman run <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/:/kubeconfig:Z <span class="nt">-e</span> <span class="nv">KUBECONFIG</span><span class="o">=</span>/kubeconfig/kubeconfig <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">LATENCY_TEST_RUNTIME</span><span class="o">=</span>600 <span class="nt">-e</span> <span class="nv">MAXIMUM_LATENCY</span><span class="o">=</span>20 <span class="se">\</span>
registry.redhat.io/openshift4/cnf-tests-rhel8:vBranch Build <span class="se">\</span>
/usr/bin/test-run.sh <span class="nt">--ginkgo</span>.focus<span class="o">=</span><span class="s2">"hwlatdetect"</span> <span class="nt">--ginkgo</span>.v <span class="nt">--ginkgo</span>.timeout<span class="o">=</span><span class="s2">"24h"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>hwlatdetect</code> test runs for 10 minutes (600 seconds). The test runs successfully when the maximum observed latency is lower than <code>MAXIMUM_LATENCY</code> (20 μs).</p>
</div>
<div class="paragraph">
<p>If the results exceed the latency threshold, the test fails.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>During testing shorter time periods, as shown, can be used to run the tests. However, for final verification and valid results, the test should run for at least 12 hours (43200 seconds).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example failure output</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">running /usr/bin/cnftests -ginkgo.v -ginkgo.focus=hwlatdetect
I0908 15:25:20.023712      27 request.go:601] Waited for 1.046586367s due to client-side throttling, not priority and fairness, request: GET:https://api.hlxcl6.lab.eng.tlv2.redhat.com:6443/apis/imageregistry.operator.openshift.io/v1?timeout=32s
Running Suite: CNF Features e2e integration tests
=================================================
Random Seed: 1662650718
Will run 1 of 3 specs

[...]

• Failure [283.574 seconds]
[performance] Latency Test
/remote-source/app/vendor/github.com/openshift/cluster-node-tuning-operator/test/e2e/performanceprofile/functests/4_latency/latency.go:62
  with the hwlatdetect image
  /remote-source/app/vendor/github.com/openshift/cluster-node-tuning-operator/test/e2e/performanceprofile/functests/4_latency/latency.go:228
    should succeed [It]
    /remote-source/app/vendor/github.com/openshift/cluster-node-tuning-operator/test/e2e/performanceprofile/functests/4_latency/latency.go:236

    Log file created at: 2022/09/08 15:25:27
    Running on machine: hwlatdetect-b6n4n
    Binary: Built with gc go1.17.12 for linux/amd64
    Log line format: [IWEF]mmdd hh:mm:ss.uuuuuu threadid file:line] msg
    I0908 15:25:27.160620       1 node.go:39] Environment information: /proc/cmdline: BOOT_IMAGE=(hd1,gpt3)/ostree/rhcos-c6491e1eedf6c1f12ef7b95e14ee720bf48359750ac900b7863c625769ef5fb9/vmlinuz-4.18.0-372.19.1.el8_6.x86_64 random.trust_cpu=on console=tty0 console=ttyS0,115200n8 ignition.platform.id=metal ostree=/ostree/boot.1/rhcos/c6491e1eedf6c1f12ef7b95e14ee720bf48359750ac900b7863c625769ef5fb9/0 ip=dhcp root=UUID=5f80c283-f6e6-4a27-9b47-a287157483b2 rw rootflags=prjquota boot=UUID=773bf59a-bafd-48fc-9a87-f62252d739d3 skew_tick=1 nohz=on rcu_nocbs=0-3 tuned.non_isolcpus=0000ffff,ffffffff,fffffff0 systemd.cpu_affinity=4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79 intel_iommu=on iommu=pt isolcpus=managed_irq,0-3 nohz_full=0-3 tsc=nowatchdog nosoftlockup nmi_watchdog=0 mce=off skew_tick=1 rcutree.kthread_prio=11 + +
    I0908 15:25:27.160830       1 node.go:46] Environment information: kernel version 4.18.0-372.19.1.el8_6.x86_64
    I0908 15:25:27.160857       1 main.go:50] running the hwlatdetect command with arguments [/usr/bin/hwlatdetect --threshold 1 --hardlimit 1 --duration 100 --window 10000000us --width 950000us]
</span><span class="gp">    F0908 15:27:10.603523       1 main.go:53] failed to run hwlatdetect command;</span><span class="w"> </span>out: hwlatdetect:  <span class="nb">test </span>duration 100 seconds
<span class="go">       detector: tracer
       parameters:
            Latency threshold: 1us <i class="conum" data-value="1"></i><b>(1)</b>
            Sample window:     10000000us
            Sample width:      950000us
         Non-sampling period:  9050000us
            Output File:       None

    Starting test
    test finished
    Max Latency: 326us <i class="conum" data-value="2"></i><b>(2)</b>
    Samples recorded: 5
    Samples exceeding threshold: 5
    ts: 1662650739.017274507, inner:6, outer:6
    ts: 1662650749.257272414, inner:14, outer:326
    ts: 1662650779.977272835, inner:314, outer:12
    ts: 1662650800.457272384, inner:3, outer:9
    ts: 1662650810.697273520, inner:3, outer:2

[...]

JUnit report was created: /junit.xml/cnftests-junit.xml


Summarizing 1 Failure:

[Fail] [performance] Latency Test with the hwlatdetect image [It] should succeed
/remote-source/app/vendor/github.com/openshift/cluster-node-tuning-operator/test/e2e/performanceprofile/functests/4_latency/latency.go:476

Ran 1 of 194 Specs in 365.797 seconds
FAIL! -- 0 Passed | 1 Failed | 0 Pending | 2 Skipped
--- FAIL: TestTest (366.08s)
FAIL</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You can configure the latency threshold by using the <code>MAXIMUM_LATENCY</code> or the <code>HWLATDETECT_MAXIMUM_LATENCY</code> environment variables.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The maximum latency value measured during the test.</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<h4 id="cnf-performing-end-to-end-tests-example-results-hwlatdetect_cnf-latency-tests" class="discrete">Example hwlatdetect test results</h4>
<div class="paragraph">
<p>You can capture the following types of results:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Rough results that are gathered after each run to create a history of impact on any changes made throughout the test.</p>
</li>
<li>
<p>The combined set of the rough tests with the best results and configuration settings.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Example of good results</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">hwlatdetect: test duration 3600 seconds
detector: tracer
parameters:
Latency threshold: 10us
Sample window: 1000000us
Sample width: 950000us
Non-sampling period: 50000us
Output File: None

Starting test
test finished
Max Latency: Below threshold
Samples recorded: 0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>hwlatdetect</code> tool only provides output if the sample exceeds the specified threshold.</p>
</div>
<div class="listingblock">
<div class="title">Example of bad results</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">hwlatdetect: test duration 3600 seconds
detector: tracer
parameters:Latency threshold: 10usSample window: 1000000us
Sample width: 950000usNon-sampling period: 50000usOutput File: None

Starting tests:1610542421.275784439, inner:78, outer:81
ts: 1610542444.330561619, inner:27, outer:28
ts: 1610542445.332549975, inner:39, outer:38
ts: 1610542541.568546097, inner:47, outer:32
ts: 1610542590.681548531, inner:13, outer:17
ts: 1610543033.818801482, inner:29, outer:30
ts: 1610543080.938801990, inner:90, outer:76
ts: 1610543129.065549639, inner:28, outer:39
ts: 1610543474.859552115, inner:28, outer:35
ts: 1610543523.973856571, inner:52, outer:49
ts: 1610543572.089799738, inner:27, outer:30
ts: 1610543573.091550771, inner:34, outer:28
ts: 1610543574.093555202, inner:116, outer:63</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output of <code>hwlatdetect</code> shows that multiple samples exceed the threshold. However, the same output can indicate different results based on the following factors:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The duration of the test</p>
</li>
<li>
<p>The number of CPU cores</p>
</li>
<li>
<p>The host firmware settings</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Before proceeding with the next latency test, ensure that the latency reported by <code>hwlatdetect</code> meets the required threshold. Fixing latencies introduced by hardware might require you to contact the system vendor support.</p>
</div>
<div class="paragraph">
<p>Not all latency spikes are hardware related. Ensure that you tune the host firmware to meet your workload requirements. For more information, see <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux_for_real_time/9/html-single/optimizing_rhel_9_for_real_time_for_low_latency_operation/index#setting-bios-parameters-for-system-tuning_optimizing-RHEL9-for-real-time-for-low-latency-operation">Setting firmware parameters for system tuning</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="cnf-performing-end-to-end-tests-running-cyclictest_cnf-latency-tests"><a class="anchor" href="#cnf-performing-end-to-end-tests-running-cyclictest_cnf-latency-tests"></a>Running cyclictest</h3>
<div class="paragraph">
<p>The <code>cyclictest</code> tool measures the real-time kernel scheduler latency on the specified CPUs.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When executing <code>podman</code> commands as a non-root or non-privileged user, mounting paths can fail with <code>permission denied</code> errors. Depending on your local operating system and SELinux configuration, you might also experience issues running these commands from your home directory. To make the <code>podman</code> commands work, run the commands from a folder that is not your home/&lt;username&gt; directory, and append <code>:Z</code> to the volumes creation. For example, <code>-v $(pwd)/:/kubeconfig:Z</code>. This allows <code>podman</code> to do the proper SELinux relabeling.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have reviewed the prerequisites for running latency tests.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>To perform the <code>cyclictest</code>, run the following command, substituting variable values as appropriate:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>podman run <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/:/kubeconfig:Z <span class="nt">-e</span> <span class="nv">KUBECONFIG</span><span class="o">=</span>/kubeconfig/kubeconfig <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">LATENCY_TEST_CPUS</span><span class="o">=</span>10 <span class="nt">-e</span> <span class="nv">LATENCY_TEST_RUNTIME</span><span class="o">=</span>600 <span class="nt">-e</span> <span class="nv">MAXIMUM_LATENCY</span><span class="o">=</span>20 <span class="se">\</span>
registry.redhat.io/openshift4/cnf-tests-rhel8:vBranch Build <span class="se">\</span>
/usr/bin/test-run.sh <span class="nt">--ginkgo</span>.focus<span class="o">=</span><span class="s2">"cyclictest"</span> <span class="nt">--ginkgo</span>.v <span class="nt">--ginkgo</span>.timeout<span class="o">=</span><span class="s2">"24h"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The command runs the <code>cyclictest</code> tool for 10 minutes (600 seconds). The test runs successfully when the maximum observed latency is lower than <code>MAXIMUM_LATENCY</code> (in this example, 20 μs). Latency spikes of 20 μs and above are generally not acceptable for telco RAN workloads.</p>
</div>
<div class="paragraph">
<p>If the results exceed the latency threshold, the test fails.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>During testing shorter time periods, as shown, can be used to run the tests. However, for final verification and valid results, the test should run for at least 12 hours (43200 seconds).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example failure output</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">running /usr/bin/cnftests -ginkgo.v -ginkgo.focus=cyclictest
I0908 13:01:59.193776      27 request.go:601] Waited for 1.046228824s due to client-side throttling, not priority and fairness, request: GET:https://api.compute-1.example.com:6443/apis/packages.operators.coreos.com/v1?timeout=32s
Running Suite: CNF Features e2e integration tests
=================================================
Random Seed: 1662642118
Will run 1 of 3 specs

[...]

Summarizing 1 Failure:

[Fail] [performance] Latency Test with the cyclictest image [It] should succeed
/remote-source/app/vendor/github.com/openshift/cluster-node-tuning-operator/test/e2e/performanceprofile/functests/4_latency/latency.go:220

Ran 1 of 194 Specs in 161.151 seconds
FAIL! -- 0 Passed | 1 Failed | 0 Pending | 2 Skipped
--- FAIL: TestTest (161.48s)
FAIL</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
<h4 id="cnf-performing-end-to-end-tests-example-results-cyclictest_cnf-latency-tests" class="discrete">Example cyclictest results</h4>
<div class="paragraph">
<p>The same output can indicate different results for different workloads. For example, spikes up to 18μs are acceptable for 4G DU workloads, but not for 5G DU workloads.</p>
</div>
<div class="listingblock">
<div class="title">Example of good results</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">running cmd: cyclictest -q -D 10m -p 1 -t 16 -a 2,4,6,8,10,12,14,16,54,56,58,60,62,64,66,68 -h 30 -i 1000 -m
</span><span class="gp">#</span><span class="w"> </span>Histogram
<span class="go">000000 000000   000000  000000  000000  000000  000000  000000  000000  000000  000000  000000  000000  000000  000000  000000  000000
000001 000000   000000  000000  000000  000000  000000  000000  000000  000000  000000  000000  000000  000000  000000  000000  000000
000002 579506   535967  418614  573648  532870  529897  489306  558076  582350  585188  583793  223781  532480  569130  472250  576043
More histogram entries ...
</span><span class="gp">#</span><span class="w"> </span>Total: 000600000 000600000 000600000 000599999 000599999 000599999 000599998 000599998 000599998 000599997 000599997 000599996 000599996 000599995 000599995 000599995
<span class="gp">#</span><span class="w"> </span>Min Latencies: 00002 00002 00002 00002 00002 00002 00002 00002 00002 00002 00002 00002 00002 00002 00002 00002
<span class="gp">#</span><span class="w"> </span>Avg Latencies: 00002 00002 00002 00002 00002 00002 00002 00002 00002 00002 00002 00002 00002 00002 00002 00002
<span class="gp">#</span><span class="w"> </span>Max Latencies: 00005 00005 00004 00005 00004 00004 00005 00005 00006 00005 00004 00005 00004 00004 00005 00004
<span class="gp">#</span><span class="w"> </span>Histogram Overflows: 00000 00000 00000 00000 00000 00000 00000 00000 00000 00000 00000 00000 00000 00000 00000 00000
<span class="gp">#</span><span class="w"> </span>Histogram Overflow at cycle number:
<span class="gp">#</span><span class="w"> </span>Thread 0:
<span class="gp">#</span><span class="w"> </span>Thread 1:
<span class="gp">#</span><span class="w"> </span>Thread 2:
<span class="gp">#</span><span class="w"> </span>Thread 3:
<span class="gp">#</span><span class="w"> </span>Thread 4:
<span class="gp">#</span><span class="w"> </span>Thread 5:
<span class="gp">#</span><span class="w"> </span>Thread 6:
<span class="gp">#</span><span class="w"> </span>Thread 7:
<span class="gp">#</span><span class="w"> </span>Thread 8:
<span class="gp">#</span><span class="w"> </span>Thread 9:
<span class="gp">#</span><span class="w"> </span>Thread 10:
<span class="gp">#</span><span class="w"> </span>Thread 11:
<span class="gp">#</span><span class="w"> </span>Thread 12:
<span class="gp">#</span><span class="w"> </span>Thread 13:
<span class="gp">#</span><span class="w"> </span>Thread 14:
<span class="gp">#</span><span class="w"> </span>Thread 15:</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example of bad results</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">running cmd: cyclictest -q -D 10m -p 1 -t 16 -a 2,4,6,8,10,12,14,16,54,56,58,60,62,64,66,68 -h 30 -i 1000 -m
</span><span class="gp">#</span><span class="w"> </span>Histogram
<span class="go">000000 000000   000000  000000  000000  000000  000000  000000  000000  000000  000000  000000  000000  000000  000000  000000  000000
000001 000000   000000  000000  000000  000000  000000  000000  000000  000000  000000  000000  000000  000000  000000  000000  000000
000002 564632   579686  354911  563036  492543  521983  515884  378266  592621  463547  482764  591976  590409  588145  589556  353518
More histogram entries ...
</span><span class="gp">#</span><span class="w"> </span>Total: 000599999 000599999 000599999 000599997 000599997 000599998 000599998 000599997 000599997 000599996 000599995 000599996 000599995 000599995 000599995 000599993
<span class="gp">#</span><span class="w"> </span>Min Latencies: 00002 00002 00002 00002 00002 00002 00002 00002 00002 00002 00002 00002 00002 00002 00002 00002
<span class="gp">#</span><span class="w"> </span>Avg Latencies: 00002 00002 00002 00002 00002 00002 00002 00002 00002 00002 00002 00002 00002 00002 00002 00002
<span class="gp">#</span><span class="w"> </span>Max Latencies: 00493 00387 00271 00619 00541 00513 00009 00389 00252 00215 00539 00498 00363 00204 00068 00520
<span class="gp">#</span><span class="w"> </span>Histogram Overflows: 00001 00001 00001 00002 00002 00001 00000 00001 00001 00001 00002 00001 00001 00001 00001 00002
<span class="gp">#</span><span class="w"> </span>Histogram Overflow at cycle number:
<span class="gp">#</span><span class="w"> </span>Thread 0: 155922
<span class="gp">#</span><span class="w"> </span>Thread 1: 110064
<span class="gp">#</span><span class="w"> </span>Thread 2: 110064
<span class="gp">#</span><span class="w"> </span>Thread 3: 110063 155921
<span class="gp">#</span><span class="w"> </span>Thread 4: 110063 155921
<span class="gp">#</span><span class="w"> </span>Thread 5: 155920
<span class="gp">#</span><span class="w"> </span>Thread 6:
<span class="gp">#</span><span class="w"> </span>Thread 7: 110062
<span class="gp">#</span><span class="w"> </span>Thread 8: 110062
<span class="gp">#</span><span class="w"> </span>Thread 9: 155919
<span class="gp">#</span><span class="w"> </span>Thread 10: 110061 155919
<span class="gp">#</span><span class="w"> </span>Thread 11: 155918
<span class="gp">#</span><span class="w"> </span>Thread 12: 155918
<span class="gp">#</span><span class="w"> </span>Thread 13: 110060
<span class="gp">#</span><span class="w"> </span>Thread 14: 110060
<span class="gp">#</span><span class="w"> </span>Thread 15: 110059 155917</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cnf-performing-end-to-end-tests-running-oslat_cnf-latency-tests"><a class="anchor" href="#cnf-performing-end-to-end-tests-running-oslat_cnf-latency-tests"></a>Running oslat</h3>
<div class="paragraph">
<p>The <code>oslat</code> test simulates a CPU-intensive DPDK application and measures all the interruptions and disruptions to test how the cluster handles CPU heavy data processing.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When executing <code>podman</code> commands as a non-root or non-privileged user, mounting paths can fail with <code>permission denied</code> errors. Depending on your local operating system and SELinux configuration, you might also experience issues running these commands from your home directory. To make the <code>podman</code> commands work, run the commands from a folder that is not your home/&lt;username&gt; directory, and append <code>:Z</code> to the volumes creation. For example, <code>-v $(pwd)/:/kubeconfig:Z</code>. This allows <code>podman</code> to do the proper SELinux relabeling.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have reviewed the prerequisites for running latency tests.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>To perform the <code>oslat</code> test, run the following command, substituting variable values as appropriate:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>podman run <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/:/kubeconfig:Z <span class="nt">-e</span> <span class="nv">KUBECONFIG</span><span class="o">=</span>/kubeconfig/kubeconfig <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">LATENCY_TEST_CPUS</span><span class="o">=</span>10 <span class="nt">-e</span> <span class="nv">LATENCY_TEST_RUNTIME</span><span class="o">=</span>600 <span class="nt">-e</span> <span class="nv">MAXIMUM_LATENCY</span><span class="o">=</span>20 <span class="se">\</span>
registry.redhat.io/openshift4/cnf-tests-rhel8:vBranch Build <span class="se">\</span>
/usr/bin/test-run.sh <span class="nt">--ginkgo</span>.focus<span class="o">=</span><span class="s2">"oslat"</span> <span class="nt">--ginkgo</span>.v <span class="nt">--ginkgo</span>.timeout<span class="o">=</span><span class="s2">"24h"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>LATENCY_TEST_CPUS</code> specifies the number of CPUs to test with the <code>oslat</code> command.</p>
</div>
<div class="paragraph">
<p>The command runs the <code>oslat</code> tool for 10 minutes (600 seconds). The test runs successfully when the maximum observed latency is lower than <code>MAXIMUM_LATENCY</code> (20 μs).</p>
</div>
<div class="paragraph">
<p>If the results exceed the latency threshold, the test fails.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>During testing shorter time periods, as shown, can be used to run the tests. However, for final verification and valid results, the test should run for at least 12 hours (43200 seconds).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example failure output</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">running /usr/bin/cnftests -ginkgo.v -ginkgo.focus=oslat
I0908 12:51:55.999393      27 request.go:601] Waited for 1.044848101s due to client-side throttling, not priority and fairness, request: GET:https://compute-1.example.com:6443/apis/machineconfiguration.openshift.io/v1?timeout=32s
Running Suite: CNF Features e2e integration tests
=================================================
Random Seed: 1662641514
Will run 1 of 3 specs

[...]

• Failure [77.833 seconds]
[performance] Latency Test
/remote-source/app/vendor/github.com/openshift/cluster-node-tuning-operator/test/e2e/performanceprofile/functests/4_latency/latency.go:62
  with the oslat image
  /remote-source/app/vendor/github.com/openshift/cluster-node-tuning-operator/test/e2e/performanceprofile/functests/4_latency/latency.go:128
    should succeed [It]
    /remote-source/app/vendor/github.com/openshift/cluster-node-tuning-operator/test/e2e/performanceprofile/functests/4_latency/latency.go:153

    The current latency 304 is bigger than the expected one 1 : <i class="conum" data-value="1"></i><b>(1)</b>

[...]

Summarizing 1 Failure:

[Fail] [performance] Latency Test with the oslat image [It] should succeed
/remote-source/app/vendor/github.com/openshift/cluster-node-tuning-operator/test/e2e/performanceprofile/functests/4_latency/latency.go:177

Ran 1 of 194 Specs in 161.091 seconds
FAIL! -- 0 Passed | 1 Failed | 0 Pending | 2 Skipped
--- FAIL: TestTest (161.42s)
FAIL</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In this example, the measured latency is outside the maximum allowed value.</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cnf-performing-end-to-end-tests-test-failure-report_cnf-latency-tests"><a class="anchor" href="#cnf-performing-end-to-end-tests-test-failure-report_cnf-latency-tests"></a>Generating a latency test failure report</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use the following procedures to generate a JUnit latency test output and test failure report.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have installed the OpenShift CLI (<code>oc</code>).</p>
</li>
<li>
<p>You have logged in as a user with <code>cluster-admin</code> privileges.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Create a test failure report with information about the cluster state and resources for troubleshooting by passing the <code>--report</code> parameter with the path to where the report is dumped:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>podman run <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/:/kubeconfig:Z <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/reportdest:&lt;report_folder_path&gt; <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">KUBECONFIG</span><span class="o">=</span>/kubeconfig/kubeconfig registry.redhat.io/openshift4/cnf-tests-rhel8:vBranch Build <span class="se">\</span>
/usr/bin/test-run.sh <span class="nt">--report</span> &lt;report_folder_path&gt; <span class="nt">--ginkgo</span>.v</code></pre>
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="openblock">
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">&lt;report_folder_path&gt; </dt>
<dd>
<p>Is the path to the folder where the report is generated.</p>
</dd>
</dl>
</div>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cnf-performing-end-to-end-tests-junit-test-output_cnf-latency-tests"><a class="anchor" href="#cnf-performing-end-to-end-tests-junit-test-output_cnf-latency-tests"></a>Generating a JUnit latency test report</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use the following procedures to generate a JUnit latency test output and test failure report.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have installed the OpenShift CLI (<code>oc</code>).</p>
</li>
<li>
<p>You have logged in as a user with <code>cluster-admin</code> privileges.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Create a JUnit-compliant XML report by passing the <code>--junit</code> parameter together with the path to where the report is dumped:</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You must create the <code>junit</code> folder before running this command.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>podman run <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/:/kubeconfig:Z <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/junit:/junit <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">KUBECONFIG</span><span class="o">=</span>/kubeconfig/kubeconfig registry.redhat.io/openshift4/cnf-tests-rhel8:vBranch Build <span class="se">\</span>
/usr/bin/test-run.sh <span class="nt">--ginkgo</span>.junit-report junit/&lt;file-name&gt;.xml <span class="nt">--ginkgo</span>.v</code></pre>
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="openblock">
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1"><code>junit</code> </dt>
<dd>
<p>Is the folder where the junit report is stored.</p>
</dd>
</dl>
</div>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cnf-performing-end-to-end-tests-running-in-single-node-cluster_cnf-latency-tests"><a class="anchor" href="#cnf-performing-end-to-end-tests-running-in-single-node-cluster_cnf-latency-tests"></a>Running latency tests on a single-node OpenShift cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can run latency tests on single-node OpenShift clusters.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When executing <code>podman</code> commands as a non-root or non-privileged user, mounting paths can fail with <code>permission denied</code> errors. To make the <code>podman</code> command work, append <code>:Z</code> to the volumes creation; for example, <code>-v $(pwd)/:/kubeconfig:Z</code>. This allows <code>podman</code> to do the proper SELinux relabeling.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have installed the OpenShift CLI (<code>oc</code>).</p>
</li>
<li>
<p>You have logged in as a user with <code>cluster-admin</code> privileges.</p>
</li>
<li>
<p>You have applied a cluster performance profile by using the Node Tuning Operator.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>To run the latency tests on a single-node OpenShift cluster, run the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>podman run <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/:/kubeconfig:Z <span class="nt">-e</span> <span class="nv">KUBECONFIG</span><span class="o">=</span>/kubeconfig/kubeconfig <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">LATENCY_TEST_RUNTIME</span><span class="o">=</span>&lt;time_in_seconds&gt; registry.redhat.io/openshift4/cnf-tests-rhel8:vBranch Build <span class="se">\</span>
/usr/bin/test-run.sh <span class="nt">--ginkgo</span>.v <span class="nt">--ginkgo</span>.timeout<span class="o">=</span><span class="s2">"24h"</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The default runtime for each test is 300 seconds.
For valid latency test results, run the tests for at least 12 hours by updating the <code>LATENCY_TEST_RUNTIME</code> variable.
To run the buckets latency validation step, you must specify a maximum latency. For details on maximum latency variables, see the table in the "Measuring latency" section.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After running the test suite, all the dangling resources are cleaned up.</p>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cnf-performing-end-to-end-tests-disconnected-mode_cnf-latency-tests"><a class="anchor" href="#cnf-performing-end-to-end-tests-disconnected-mode_cnf-latency-tests"></a>Running latency tests in a disconnected cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The CNF tests image can run tests in a disconnected cluster that is not able to reach external registries. This requires two steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Mirroring the <code>cnf-tests</code> image to the custom disconnected registry.</p>
</li>
<li>
<p>Instructing the tests to consume the images from the custom disconnected registry.</p>
</li>
</ol>
</div>
<h3 id="cnf-performing-end-to-end-tests-mirroring-images-to-custom-registry_cnf-latency-tests" class="discrete">Mirroring the images to a custom registry accessible from the cluster</h3>
<div class="paragraph">
<p>A <code>mirror</code> executable is shipped in the image to provide the input required by <code>oc</code> to mirror the test image to a local registry.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run this command from an intermediate machine that has access to the cluster and <a href="https://catalog.redhat.com/software/containers/explore">registry.redhat.io</a>:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>podman run <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/:/kubeconfig:Z <span class="nt">-e</span> <span class="nv">KUBECONFIG</span><span class="o">=</span>/kubeconfig/kubeconfig <span class="se">\</span>
registry.redhat.io/openshift4/cnf-tests-rhel8:vBranch Build <span class="se">\</span>
/usr/bin/mirror <span class="nt">-registry</span> &lt;disconnected_registry&gt; | oc image mirror <span class="nt">-f</span> -</code></pre>
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="openblock">
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">&lt;disconnected_registry&gt; </dt>
<dd>
<p>Is the disconnected mirror registry you have configured, for example, <code>my.local.registry:5000/</code>.</p>
</dd>
</dl>
</div>
</div>
</div>
</li>
<li>
<p>When you have mirrored the <code>cnf-tests</code> image into the disconnected registry, you must override the original registry used to fetch the images when running the tests, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">podman run -v $</span><span class="o">(</span><span class="nb">pwd</span><span class="o">)</span>/:/kubeconfig:Z <span class="nt">-e</span> <span class="nv">KUBECONFIG</span><span class="o">=</span>/kubeconfig/kubeconfig <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">IMAGE_REGISTRY</span><span class="o">=</span><span class="s2">"&lt;disconnected_registry&gt;"</span> <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">CNF_TESTS_IMAGE</span><span class="o">=</span><span class="s2">"cnf-tests-rhel8:vBranch Build"</span> <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">LATENCY_TEST_RUNTIME</span><span class="o">=</span>&lt;time_in_seconds&gt; <span class="se">\</span>
&lt;disconnected_registry&gt;/cnf-tests-rhel8:vBranch Build /usr/bin/test-run.sh <span class="nt">--ginkgo</span>.v <span class="nt">--ginkgo</span>.timeout<span class="o">=</span><span class="s2">"24h"</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
<h3 id="cnf-performing-end-to-end-tests-image-parameters_cnf-latency-tests" class="discrete">Configuring the tests to consume images from a custom registry</h3>
<div class="paragraph">
<p>You can run the latency tests using a custom test image and image registry using <code>CNF_TESTS_IMAGE</code> and <code>IMAGE_REGISTRY</code> variables.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To configure the latency tests to use a custom test image and image registry, run the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>podman run <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/:/kubeconfig:Z <span class="nt">-e</span> <span class="nv">KUBECONFIG</span><span class="o">=</span>/kubeconfig/kubeconfig <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">IMAGE_REGISTRY</span><span class="o">=</span><span class="s2">"&lt;custom_image_registry&gt;"</span> <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">CNF_TESTS_IMAGE</span><span class="o">=</span><span class="s2">"&lt;custom_cnf-tests_image&gt;"</span> <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">LATENCY_TEST_RUNTIME</span><span class="o">=</span>&lt;time_in_seconds&gt; <span class="se">\</span>
registry.redhat.io/openshift4/cnf-tests-rhel8:vBranch Build /usr/bin/test-run.sh <span class="nt">--ginkgo</span>.v <span class="nt">--ginkgo</span>.timeout<span class="o">=</span><span class="s2">"24h"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="openblock">
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">&lt;custom_image_registry&gt; </dt>
<dd>
<p>is the custom image registry, for example, <code>custom.registry:5000/</code>.</p>
</dd>
<dt class="hdlist1">&lt;custom_cnf-tests_image&gt; </dt>
<dd>
<p>is the custom cnf-tests image, for example, <code>custom-cnf-tests-image:latest</code>.</p>
</dd>
</dl>
</div>
</div>
</div>
</li>
</ul>
</div>
<h3 id="cnf-performing-end-to-end-tests-mirroring-to-cluster-internal-registry_cnf-latency-tests" class="discrete">Mirroring images to the cluster OpenShift image registry</h3>
<div class="paragraph">
<p>OpenShift Container Platform provides a built-in container image registry, which runs as a standard workload on the cluster.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Gain external access to the registry by exposing it with a route:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>oc patch configs.imageregistry.operator.openshift.io/cluster <span class="nt">--patch</span> <span class="s1">'{"spec":{"defaultRoute":true}}'</span> <span class="nt">--type</span><span class="o">=</span>merge</code></pre>
</div>
</div>
</li>
<li>
<p>Fetch the registry endpoint by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span><span class="nv">REGISTRY</span><span class="o">=</span><span class="si">$(</span>oc get route default-route <span class="nt">-n</span> openshift-image-registry <span class="nt">--template</span><span class="o">=</span><span class="s1">'{{ .spec.host }}'</span><span class="si">)</span></code></pre>
</div>
</div>
</li>
<li>
<p>Create a namespace for exposing the images:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>oc create ns cnftests</code></pre>
</div>
</div>
</li>
<li>
<p>Make the image stream available to all the namespaces used for tests. This is required to allow the tests namespaces to fetch the images from the <code>cnf-tests</code> image stream. Run the following commands:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>oc policy add-role-to-user system:image-puller system:serviceaccount:cnf-features-testing:default <span class="nt">--namespace</span><span class="o">=</span>cnftests</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>oc policy add-role-to-user system:image-puller system:serviceaccount:performance-addon-operators-testing:default <span class="nt">--namespace</span><span class="o">=</span>cnftests</code></pre>
</div>
</div>
</li>
<li>
<p>Retrieve the docker secret name and auth token by running the following commands:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span><span class="nv">SECRET</span><span class="o">=</span><span class="si">$(</span>oc <span class="nt">-n</span> cnftests get secret | <span class="nb">grep </span>builder-docker | <span class="nb">awk</span> <span class="o">{</span><span class="s1">'print $1'</span><span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span><span class="nv">TOKEN</span><span class="o">=</span><span class="si">$(</span>oc <span class="nt">-n</span> cnftests get secret <span class="nv">$SECRET</span> <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.data['</span><span class="se">\.</span><span class="s2">dockercfg']}"</span> | <span class="nb">base64</span> <span class="nt">--decode</span> | jq <span class="s1">'.["image-registry.openshift-image-registry.svc:5000"].auth'</span><span class="si">)</span></code></pre>
</div>
</div>
</li>
<li>
<p>Create a <code>dockerauth.json</code> file, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="bash"><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"{</span><span class="se">\"</span><span class="s2">auths</span><span class="se">\"</span><span class="s2">: { </span><span class="se">\"</span><span class="nv">$REGISTRY</span><span class="se">\"</span><span class="s2">: { </span><span class="se">\"</span><span class="s2">auth</span><span class="se">\"</span><span class="s2">: </span><span class="nv">$TOKEN</span><span class="s2"> } }}"</span> <span class="o">&gt;</span> dockerauth.json</code></pre>
</div>
</div>
</li>
<li>
<p>Do the image mirroring:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>podman run <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/:/kubeconfig:Z <span class="nt">-e</span> <span class="nv">KUBECONFIG</span><span class="o">=</span>/kubeconfig/kubeconfig <span class="se">\</span>
registry.redhat.io/openshift4/cnf-tests-rhel8:Branch Build <span class="se">\</span>
/usr/bin/mirror <span class="nt">-registry</span> <span class="nv">$REGISTRY</span>/cnftests |  oc image mirror <span class="nt">--insecure</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">-a</span><span class="o">=</span><span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/dockerauth.json <span class="nt">-f</span> -</code></pre>
</div>
</div>
</li>
<li>
<p>Run the tests:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>podman run <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/:/kubeconfig:Z <span class="nt">-e</span> <span class="nv">KUBECONFIG</span><span class="o">=</span>/kubeconfig/kubeconfig <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">LATENCY_TEST_RUNTIME</span><span class="o">=</span>&lt;time_in_seconds&gt; <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">IMAGE_REGISTRY</span><span class="o">=</span>image-registry.openshift-image-registry.svc:5000/cnftests cnf-tests-local:latest /usr/bin/test-run.sh <span class="nt">--ginkgo</span>.v <span class="nt">--ginkgo</span>.timeout<span class="o">=</span><span class="s2">"24h"</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
<h3 id="mirroring-different-set-of-images_cnf-latency-tests" class="discrete">Mirroring a different set of test images</h3>
<div class="paragraph">
<p>You can optionally change the default upstream images that are mirrored for the latency tests.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>The <code>mirror</code> command tries to mirror the upstream images by default. This can be overridden by passing a file with the following format to the image:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="pi">[</span>
    <span class="pi">{</span>
        <span class="s2">"</span><span class="s">registry"</span><span class="pi">:</span> <span class="s2">"</span><span class="s">public.registry.io:5000"</span><span class="pi">,</span>
        <span class="s2">"</span><span class="s">image"</span><span class="pi">:</span> <span class="s2">"</span><span class="s">imageforcnftests:Branch</span><span class="nv"> </span><span class="s">Build"</span>
    <span class="pi">}</span>
<span class="pi">]</span></code></pre>
</div>
</div>
</li>
<li>
<p>Pass the file to the <code>mirror</code> command, for example saving it locally as <code>images.json</code>. With the following command, the local path is mounted in <code>/kubeconfig</code> inside the container and that can be passed to the mirror command.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>podman run <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/:/kubeconfig:Z <span class="nt">-e</span> <span class="nv">KUBECONFIG</span><span class="o">=</span>/kubeconfig/kubeconfig <span class="se">\</span>
registry.redhat.io/openshift4/cnf-tests-rhel8:vBranch Build /usr/bin/mirror <span class="se">\</span>
<span class="nt">--registry</span> <span class="s2">"my.local.registry:5000/"</span> <span class="nt">--images</span> <span class="s2">"/kubeconfig/images.json"</span> <span class="se">\</span>
|  oc image mirror <span class="nt">-f</span> -</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cnf-performing-end-to-end-tests-troubleshooting_cnf-latency-tests"><a class="anchor" href="#cnf-performing-end-to-end-tests-troubleshooting_cnf-latency-tests"></a>Troubleshooting errors with the cnf-tests container</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To run latency tests, the cluster must be accessible from within the <code>cnf-tests</code> container.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have installed the OpenShift CLI (<code>oc</code>).</p>
</li>
<li>
<p>You have logged in as a user with <code>cluster-admin</code> privileges.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Verify that the cluster is accessible from inside the <code>cnf-tests</code> container by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>podman run <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/:/kubeconfig:Z <span class="nt">-e</span> <span class="nv">KUBECONFIG</span><span class="o">=</span>/kubeconfig/kubeconfig <span class="se">\</span>
registry.redhat.io/openshift4/cnf-tests-rhel8:vBranch Build <span class="se">\</span>
oc get nodes</code></pre>
</div>
</div>
<div class="paragraph">
<p>If this command does not work, an error related to spanning across DNS, MTU size, or firewall access might be occurring.</p>
</div>
</li>
</ul>
</div>
</div>
</div>
      </div>
    </div>
  </div>
  <script src="https://assets.openshift.net/content/modernizr.js" type="text/javascript"></script>
  <script src="https://assets.openshift.net/content/subdomain.js" type="text/javascript"></script>
  <script src="https://assets.openshift.net/content/nav-tertiary.js" type="text/javascript"></script>
  <script src="https://docs.okd.io/latest/_javascripts/bootstrap-offcanvas.js" type="text/javascript"></script>
  <script src="https://docs.okd.io/latest/_javascripts/reformat-html.js" type="text/javascript"></script>
  <script src="https://docs.okd.io/latest/_javascripts/hc-search.js" type="text/javascript"></script>
  <script src="https://docs.okd.io/latest/_javascripts/page-loader.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" type="text/javascript"></script>
  <script src="https://docs.okd.io/latest/_javascripts/clipboard.js" type="text/javascript"></script>
  <script src="https://docs.okd.io/latest/_javascripts/collapsible.js" type="text/javascript"></script>
  <script>
  var dk = 'openshift-webscale';
  var version = 'Branch Build';

  var distros = {
    'openshift-origin': ['docs_origin', version],
    // specific labels are used for OSD instead of the URL filter, due to its unusual URL structure; assume v4
    'openshift-dedicated': ['docs_dedicated_v4'],
    'openshift-online': ['docs_online', version],
    'openshift-enterprise': ['docs_cp', version],
    'openshift-telco': ['docs_telco', version],
    'openshift-aro' : ['docs_aro', version],
    'openshift-rosa' : ['docs_rosa'],
    'openshift-acs' : ['docs_acs', version],
    'openshift-serverless' : ['docs_serverless', version],
    'openshift-pipelines' : ['docs_pipelines', version],
    'openshift-builds' : ['docs_builds', version],
    'openshift-gitops' : ['docs_gitops', version],
    'openshift-lightspeed' : ['docs_lightspeed', version],
    'openshift-service-mesh' : ['docs_service_mesh', version]
  };

  // only OSD v3 docs have the version variable specified
  if (dk == "openshift-dedicated" && version == "3") {
    distros['openshift-dedicated'] = ['docs_dedicated_v3']
  }

  distros[dk] ? hcSearchCategory.apply(null, distros[dk]) : hcSearchCategory("docs");
  </script>
  <script type="text/javascript">
  /*<![CDATA[*/
  $(document).ready(function() {
    $("[id^='topicGroup']").on('show.bs.collapse', function(event) {
      if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
        $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
      }
    });
    $("[id^='topicGroup']").on('hide.bs.collapse', function(event) {
      if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
        $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
      }
    });
    $("[id^='topicSubGroup']").on('show.bs.collapse', function() {
      $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
    });
    $("[id^='topicSubGroup']").on('hide.bs.collapse', function() {
      $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
    });
    $("[id^='topicSubSubGroup']").on('show.bs.collapse', function() {
      $(this).parent().find("[id^='ssgSpan']").toggleClass("fa-caret-right fa-caret-down");
    });
    $("[id^='topicSubSubGroup']").on('hide.bs.collapse', function() {
      $(this).parent().find("[id^='ssgSpan']").toggleClass("fa-caret-right fa-caret-down");
    });

    const collapsibleContent = document.getElementsByTagName("details");
    for (var i = 0; i < collapsibleContent.length; i++) {
      collapsibleContent[i].setAttribute("open", "");
    }

  });
  /*]]>*/
  </script>

  <footer id="rh">

    <div class="container">
        <div class="row">

            <div class="col-sm-2">
                <img src="https://assets.openshift.net/content/img/Logo-Red_Hat-OpenShift-A-Reverse-RGB.svg" class="img-fluid" alt="Red Hat" style="height: 30px;">
            </div>

            <div class="col-sm-3">
              <p class="text-nowrap">Copyright © 2025 Red Hat, Inc.</p>
            </div>



            <div class="col">
                <nav class="nav">
                    <a target="_blank" href="https://www.redhat.com/en/about/privacy-policy" class="nav-link">Privacy statement</a>
                    <a target="_blank" href="https://www.openshift.com/legal/terms/" class="nav-link">Terms of use</a>
                    <a target="_blank" href="https://www.redhat.com/en/about/all-policies-guidelines" class="nav-link">All policies and guidelines</a>
                    <a id="teconsent"></a>
                </nav>
            </div>
        </div>
    </div>
</footer>
<div id="consent_blackbar" style="z-index: 100; position: fixed"></div>



<!-- Adobe DTM -->
<script type="text/javascript">
if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
   _satellite.pageBottom();
}
</script>
<!-- End Adobe DTM -->

  <!-- adjust page css based on breadcrumb and/or resize -->
  <script type="text/javascript">
    window.addEventListener('DOMContentLoaded', () => {
      if ($(window).width() >= 1008) {
        adjustSide();
        adjustToc();
        adjustMain();
      }
    });

    window.addEventListener('resize', () => {
      if ($(window).width() >= 1008) {
        adjustSide();
        adjustToc();
        adjustMain();
      } else if ($(window).width() < 1008) {
        sidebar.classList.remove('wide');
        document.querySelector('#hc-search').classList.remove('wide');
        if (sidebar.classList.contains('open')) {
          sidebar.style.display = 'block';
        } else {
          sidebar.style.display = 'none';
        }
        document.querySelector('.main').style.paddingTop = '0px';
      }
    });

    function adjustSide() {
      sidebar.classList.add('wide');
      document.querySelector('#hc-search').classList.add('wide');
      sidebar.style.display = 'block';
      document.querySelector('.sidebar').style.top = parseInt((document.querySelector('.breadcrumb').offsetHeight + 125), 10) + "px";
      document.querySelector('#hc-search').style.top = parseInt((document.querySelector('.breadcrumb').offsetHeight + 95), 10) + "px";
    }

    function adjustToc() {
      if (document.querySelector('#toc') !== null) {
        document.querySelector('#toc').style.top = parseInt((document.querySelector('.breadcrumb').offsetHeight + 90), 10) + "px";
      }
    }

    function adjustMain() {
      document.querySelector('html').style.scrollPaddingTop = parseInt((document.querySelector('.breadcrumb').offsetHeight + 90), 10) + "px";
      document.querySelector('.main').style.paddingTop = parseInt((document.querySelector('.breadcrumb').offsetHeight - 70), 10) + "px";
    }

  </script>

  <!-- remove toc active class when page is loaded -->
  <script type="text/javascript">
    window.addEventListener('DOMContentLoaded', () => {
      var tocItems = $("#toc a");

      for (let i = 0; i < tocItems.length; i++) {
        tocItems[i].classList.remove("toc-active");
      }
    })
  </script>

  <!-- maintain sidebar scroll position between page loads -->
  <script type="text/javascript">
    let sidebar = document.querySelector(".sidebar");
    let scrolltop = localStorage.getItem("sidebar-scroll");

    if (scrolltop == null) {
      sidebar.scrollTop = parseInt(top, 10);
    }

    window.addEventListener("beforeunload", () => {
      localStorage.setItem("sidebar-scroll", sidebar.scrollTop);
    });

    window.addEventListener('load', () => {
      sidebar.scrollTo(0, scrolltop)
    })
  </script>

  <!-- open/close the nav -->
  <script type="text/javascript">
    function closeNav() {
      let sidebar = document.querySelector(".sidebar");
      sidebar.style.display = "none";
      sidebar.classList.remove('open');
    }

    function openNav() {
      let sidebar = document.querySelector(".sidebar");
      let hc_search = document.querySelector('#hc-search');
      sidebar.style.display = "block";
      sidebar.style.top = "0px";
      hc_search.style.top = 'unset';
      sidebar.classList.add('open');
    }
  </script>

  <!-- clear and add toc-active to clicked toc link -->
  <script type="text/javascript">
  $("#toc a").click(function() {
    var tocItems = $("#toc a");
    for (let i = 0; i < tocItems.length; i++) {
      tocItems[i].classList.remove("toc-active");
    }
    this.classList.add("toc-active");
  });
  </script>

  <!-- update active toc class when mouse scrolls -->
  <script type="text/javascript">
    window.addEventListener('DOMContentLoaded', () => {
      window.addEventListener("wheel", () => {

        const ioConfiguration = {
          "rootMargin": "-120px 0px -400px 0px",
          "threshold": 0
        };

        const observer = new IntersectionObserver(setCurrent, ioConfiguration, entries => {
          entries.forEach(entry => {
            var id = entry.target.getAttribute('id');
            //fight with js
            document.querySelector(`#toc li a[href="#${id}"]`).classList.remove('toc-active');
          });
        });

        //track all h1-4 headings that have an id
        document.querySelectorAll('.main h2[id], .main h3[id]').forEach((h) => {
          observer.observe(h);
        });

        //runs when the IntersectionObserver fires
        function setCurrent(e) {
          var allTocLinks = document.querySelectorAll("#toc li a");
          if (allTocLinks !== undefined) {
            e.map(i => {
              if (i.isIntersecting && i.intersectionRatio >= 1) {
                allTocLinks.forEach(link => link.classList.remove("toc-active"));
                document.querySelector(`#toc li a[href="#${i.target.id}"]`).classList.add('toc-active')
              }
            })
          }
        };

        //make clicked toc item active and stop IntersectionObserver
        $("#toc a").click(function() {
          //stop tracking all h1-4 headings that have an id
          document.querySelectorAll('.main h2[id], .main h3[id]').forEach((h) => {
            observer.unobserve(h);
          });
          var tocItems = $("#toc a");
          if (tocItems !== undefined) {
            for (let i = 0; i < tocItems.length; i++) {
              tocItems[i].classList.remove("toc-active");
            };
            this.classList.add("toc-active");
          }
        })
      })
    })
  </script>

  <!--handle page scroll top and bottom, add toc-active -->
  <script type="text/javascript">
    document.addEventListener('scroll', () => {
      //scroll to bottom
      if(document.documentElement.scrollHeight === window.pageYOffset + window.innerHeight) {
        var tocItems = $("#toc a");
        for (let i = 0; i < tocItems.length; i++) {
          tocItems[i].classList.remove("toc-active")
          };
          tocItems[tocItems.length - 1].classList.add("toc-active");
        };
      //scroll to top
      if(window.pageYOffset === 0) {
        var tocItems = $("#toc a");
        for (let i = 0; i < tocItems.length; i++) {
          tocItems[i].classList.remove("toc-active");
          };
          tocItems[0].classList.add("toc-active");
        };
      })
  </script>

  <!-- adjust alerts on mobile -->
  <script type="text/javascript">
    alert = document.querySelector('#support-alert')
    window.addEventListener("wheel", () => {
      if ($(window).width() < 1008) {
        //adjust alert
        if(window.pageYOffset > 0) {
          if(alert !== null) {
            document.querySelector('#support-alert').style.position = "fixed";
            document.querySelector('#support-alert').style.bottom = "0px";
            document.querySelector('#support-alert').style.margin = "5px";
            document.querySelector('#support-alert').style.zIndex = "9999999";
          }
        }
      }
   });
    window.addEventListener('resize', () => {
      if ($(window).width() >= 1008) {
        if(alert !== null) {
          document.querySelector('#support-alert').style.removeProperty('position');
          document.querySelector('#support-alert').style.removeProperty('bottom');
          document.querySelector('#support-alert').style.removeProperty('margin');
          document.querySelector('#support-alert').style.removeProperty('zIndex');
        }
      }
    })
  </script>

  <!-- hide footer after 3 seconds -->
  <script type="text/javascript">
    const hideFooter = () => {
      document.querySelector('footer#rh, footer.footer-origin-docs').style.display = "none";
    };

    window.addEventListener('load', function() {
      setTimeout(hideFooter, 3000);
    });
  </script>
</body>
</html>