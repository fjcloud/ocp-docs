

<!DOCTYPE html>
<!--[if IE 8]> <html class="ie8"> <![endif]-->
<!--[if IE 9]> <html class="ie9"> <![endif]-->
<!--[if gt IE 9]><!-->
<html>
<!--<![endif]-->

<head>
  <meta charset="utf-8">
  <meta content="IE=edge" http-equiv="X-UA-Compatible">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  
  <meta name="robots" content="noindex,nofollow">
  
  <title>Tuning nodes for low latency with the performance profile | Scalability and performance | OpenShift Container Platform Branch Build</title>
  <link href="https://assets.openshift.net/content/subdomain.css" rel="stylesheet" type="text/css"/>
  <link href="https://docs.okd.io/latest/_stylesheets/search.css" rel="stylesheet" media="screen"/>
  <link href="https://docs.okd.io/latest/_stylesheets/autumn.css" rel="stylesheet"  media="screen"/>
  <link href="https://assets.openshift.net/content/subdomain/touch-icon-precomposed.png" rel="apple-touch-icon-precomposed" type="image/png"/>
  <link href="https://assets.openshift.net/content/subdomain/favicon32x32.png" rel="shortcut icon" type="text/css"/>
  <link href="https://assets.openshift.net/content/osh-nav-footer.css" rel="stylesheet" type="text/css" media="screen"/>
  <link href="https://docs.okd.io/latest/_stylesheets/docs.css" rel="stylesheet"  media="screen"/>
  <link href="https://docs.okd.io/latest/_stylesheets/print.css" rel="stylesheet" type="text/css" media="print"/>
  <!--[if IE]><link rel="shortcut icon" href="https://assets.openshift.net/content/subdomain/favicon.ico"><![endif]-->
  <!-- or, set /favicon.ico for IE10 win -->
  <meta content="OpenShift" name="application-name">
  <meta content="#000000" name="msapplication-TileColor">
  <meta content="https://assets.openshift.net/content/subdomain/touch-icon-precomposed.png" name="msapplication-TileImage">

  <!-- Adobe DTM -->
  <script src="//www.redhat.com/dtm.js" type="text/javascript"></script>
  <!-- End Adobe DTM -->

  <script id="trustarc" src="https://static.redhat.com/libs/redhat/marketing/latest/trustarc/trustarc.js"></script>

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined"
        rel="stylesheet">

</head>

<body onload="selectVersion('Branch Build');">
  
<nav id="main">
  <div class="container">
    <div class="row">
      <div class="navbar navbar-default navbar-openshift" role="navigation">
        <div class="navbar-header">
            <a href="#nav-main" class="dropdown-toggle navbar-menu-toggle hidden visible-xs" data-toggle="collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </a>
          <a class="navbar-brand" href="/"></a>
        </div>
        <div id="nav-main" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li id="products" class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-expanded="true">
                Products <span class="fa fa-angle-down"></span>
              </a>
              <div class="dropdown-menu">
                <div class="row flex-column flex-md-row">
                  <div class="col-xs-12 col-sm-3">
                    <h3>Overview</h3>
                    <ul class="nav flex-column">
                      <li><a target="_blank" href="https://www.openshift.com/products/features/">Features</a></li>
                      <li><a target="_blank" href="https://www.openshift.com/products/pricing/">Pricing</a></li>
                    </ul>
                  </div>
                  <div class="col-xs-12 col-sm-9">
                    <h3>Featured Products</h3>
                    <ul class="nav">
                      <li>
                        <a target="_blank" href="https://www.openshift.com/products/container-platform/">Red Hat OpenShift Container&nbsp;Platform</a>
                        <p class="d-none d-md-block">Build, deploy and manage your applications across cloud- and on-premise infrastructure</p>
                      </li>
                      <li>
                        <a target="_blank" href="https://www.openshift.com/products/dedicated/">Red Hat OpenShift Dedicated</a>
                        <p class="d-none d-md-block">Single-tenant, high-availability Kubernetes clusters in the public cloud</p>
                      </li>

                      <li>
                        <a target="_blank" href="https://www.openshift.com/products/online/">Red Hat OpenShift Online</a>
                        <p class="d-none d-md-block">The fastest way for developers to build, host and scale applications in the public cloud</p>
                      </li>

                      <li class="nav-item">
                        <a target="_blank" href="https://www.openshift.com/products/">All products <span class="fa fa-angle-right"></span></a>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </li>

            <li id="learn" class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                Learn <span class="fa fa-angle-down"></span>
              </a>
              <div class="dropdown-menu">
                <div class="row flex-md-nowrap">
                  <div class="col-xs-12 col-sm-6">
                    <h3>Learn</h3>
                    <ul class="nav">
                      <li><a target="_blank" href="https://www.openshift.com/learn/what-is-openshift/">What is OpenShift</a></li>
                      <li><a target="_blank" href="https://www.openshift.com/learn/get-started/">Get started</a></li>
                      <li><a target="_blank" href="https://www.openshift.com/learn/partners/">Partners</a></li>
                      <li><a target="_blank" href="https://www.openshift.com/learn/success-stories/">Customer success stories</a></li>
                      <li><a target="_blank" href="https://blog.openshift.com">Blog</a></li>
                      <li><a target="_blank" href="https://www.openshift.com/learn/resources/">Resources</a></li>
                    </ul>
                  </div>
                  <div class="col-xs-12 col-sm-6">
                    <h3>Technology Topics</h3>
                    <ul class="nav">
                      <li><a target="_blank" href="https://www.openshift.com/learn/topics/knative/">Knative</a></li>
                      <li><a target="_blank" href="https://www.openshift.com/learn/topics/security/">Security</a></li>
                      <li><a target="_blank" href="https://www.openshift.com/learn/topics/kubernetes/">Kubernetes</a></li>
                      <li><a target="_blank" href="https://www.openshift.com/learn/topics/service-brokers/">Service Brokers</a></li>
                    </ul>
                  </div>
                </div>
              </div>
            </li>

            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                Community <span class="fa fa-angle-down"></span>
              </a>
              <ul class="dropdown-menu">
                <li><a target="_blank" href="https://commons.openshift.org">OpenShift Commons</a></li>
                <li><a target="_blank" href="https://www.okd.io">Open Source (OKD)</a></li>
                <li><a target="_blank" href="https://www.openshift.com/community/programs/startups/">Startups</a></li>
                <li><a target="_blank" href="https://www.openshift.com/community/programs/grants/">Grants</a></li>
              </ul>
            </li>

            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                Support <span class="fa fa-angle-down"></span>
              </a>
              <ul class="dropdown-menu">
                <li><a target="_blank" href="https://help.openshift.com">Help Center</a></li>
                <li><a href="https://docs.openshift.com">OpenShift Docs</a></li>
              </ul>
            </li>

            <li><a target="_blank" class="nav-sign-up" href="https://www.openshift.com/trial/">Free Trial</a></li>

            <li><a target="_blank" href="https://console.redhat.com/openshift" class="nav-sign-in">Log In <span class="fa fa-angle-right"></span></a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</nav>

  
  <div class="container">
    <button id="hc-open-btn" class="open-btn-sm" onclick="openNav()" aria-label="Open"><span class="fa fa-bars" /></button>
    <ol class="breadcrumb hide-for-print">
      

      
      <span>
        <div class="alert alert-danger" role="alert" id="support-alert">
          <strong>This documentation is work in progress and might not be complete or fully tested.</strong> The latest supported version of version 3 is <a href="https://docs.openshift.com/container-platform/3.11/welcome/index.html" class="link-primary" style="color: #545454 !important;">[3.11]</a>. For the most recent version 4, see <a href="https://docs.openshift.com/container-platform/latest/welcome/index.html" style="color: #545454 !important" class="link-primary">[4]</a>.
        </div>
      </span>
      

      

      

      

      

      

      
      

      

      


      

      


      

      

      <li class="sitename">
        <a href="/">
          Documentation</a>
      </li>
      <li class="hidden-xs active">
        
          <a href="../welcome/index.html">OpenShift Container Platform Branch Build</a>
        
      </li>
      <li class="hidden-xs active">
        <a href="../scalability_and_performance/index.html">Scalability and performance</a>
      </li>
      
      
      <li class="hidden-xs active">
        Tuning nodes for low latency with the performance profile
      </li>
      
      <span text-align="right" style="float: right !important">
        <a href="https://github.com/openshift/openshift-docs/commits/main/scalability_and_performance/cnf-tuning-low-latency-nodes-with-perf-profile.adoc"><span class="material-icons-outlined" title="Page history">history</span></a>
        
        <a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12332330&issuetype=1&components=12367614&priority=4&summary=Issue+in+file+scalability_and_performance/cnf-tuning-low-latency-nodes-with-perf-profile.adoc">
          <span class="material-icons-outlined" title="Open an issue">bug_report</span>
        </a>
        <a href="javascript: void(0);" onclick="window.print()"><span class="material-icons-outlined" title="Print page (Save as PDF)">picture_as_pdf</span></a>
        
        
      </span>
      
    </ol>
    <div class="row row-offcanvas row-offcanvas-left">
      <div class="col-xs-8 col-sm-3 col-md-3 sidebar sidebar-offcanvas hide-for-print">
        <div class="row-fluid">
          <div id="btn-close">
            <button id="hc-close-btn" onclick="closeNav()" class="close-btn-sm" aria-label="close"><span class="fa fa-times" /></button>
          </div>
          <div id="hc-search">
            <input id="hc-search-input" type="text" aria-label="search">
            <button id="hc-search-btn" aria-label="search"><span class="fa fa-search" /></button>
          </div>
        </div>
        <ul class="nav nav-sidebar">
    <li class="nav-header"><a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicGroup0"><span id="tgSpan0" class="fa fa-angle-right"></span>About</a>
      <ul id="topicGroup0" class="collapse  list-unstyled">
            <li><a class="" href="../welcome/index.html">Welcome</a></li>
            <li><a class="" href="../welcome/learn_more_about_openshift.html">Learn more about OpenShift Container Platform</a></li>
      </ul>
    </li>
    <li class="nav-header"><a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicGroup1"><span id="tgSpan1" class="fa fa-angle-down"></span>Scalability and performance</a>
      <ul id="topicGroup1" class="collapse in list-unstyled">
            <li><a class="" href="../scalability_and_performance/index.html">Scalability and performance overview</a></li>
            <li><a class="" href="../scalability_and_performance/telco-core-rds.html">Telco core reference design specifications</a></li>
            <li><a class="" href="../scalability_and_performance/telco-ran-du-rds.html">Telco RAN DU reference design specifications</a></li>
            <li><a class="" href="../scalability_and_performance/compute-resource-quotas.html">Compute Resource Quotas</a></li>
            <li><a class="" href="../scalability_and_performance/cnf-understanding-low-latency.html">Understanding low latency</a></li>
            <li><a class=" active" href="../scalability_and_performance/cnf-tuning-low-latency-nodes-with-perf-profile.html">Tuning nodes for low latency with the performance profile</a></li>
            <li><a class="" href="../scalability_and_performance/cnf-provisioning-low-latency-workloads.html">Provisioning real-time and low latency workloads</a></li>
            <li><a class="" href="../scalability_and_performance/cnf-debugging-low-latency-tuning-status.html">Debugging low latency tuning</a></li>
            <li><a class="" href="../scalability_and_performance/cnf-performing-platform-verification-latency-tests.html">Performing latency tests for platform verification</a></li>
      </ul>
    </li>
</ul>
      </div>
      <div id="hc-search-modal">
        <div id="hc-modal-content">
          <span id="hc-modal-close">&times;</span>
          <div id="hc-search-results-wrapper">
            <div id="hc-search-results"></div>
            <div id="hc-search-progress-indicator" class="text-center search-progress-indicator"><i class="fa fa-circle-o-notch fa-spin" style="font-size:42px"></i></div>
            <div class="text-center">
              <button id="hc-search-more-btn">Show more results</button>
            </div>
          </div>
        </div>
      </div>
      <div class="print-logo" style="display:none;">
        <img src="https://www.redhat.com/cms/managed-files/Logo-Red_Hat-OpenShift-A-Standard-RGB_0_0.svg" alt="print logo"/>
      </div>
      <div class="col-xs-12 col-sm-9 col-md-9 main">
        <div class="page-header">
          <h1>
            Tuning nodes for low latency with the performance profile
          </h1>
        </div>
        
        
        <div id="preamble">
<div class="sectionbody">
<div id="toc" class="toc">
<div id="toctitle" class="title"></div>
<ul class="sectlevel1">
<li><a href="#cnf-create-performance-profiles">Creating a performance profile</a>
<ul class="sectlevel2">
<li><a href="#cnf-about-the-profile-creator-tool_cnf-low-latency-perf-profile">About the Performance Profile Creator</a></li>
<li><a href="#creating-mcp-for-ppc_cnf-low-latency-perf-profile">Creating a machine config pool to target nodes for performance tuning</a></li>
<li><a href="#gathering-data-about-your-cluster-using-must-gather_cnf-low-latency-perf-profile">Gathering data about your cluster for the PPC</a></li>
<li><a href="#running-the-performance-profile-profile-cluster-using-podman_cnf-low-latency-perf-profile">Running the Performance Profile Creator using Podman</a></li>
<li><a href="#running-the-performance-profile-creator-wrapper-script_cnf-low-latency-perf-profile">Running the Performance Profile Creator wrapper script</a></li>
<li><a href="#performance-profile-creator-arguments_cnf-low-latency-perf-profile">Performance Profile Creator arguments</a></li>
<li><a href="#cnf-create-performance-profiles-reference">Reference performance profiles</a></li>
</ul>
</li>
<li><a href="#nto_supported_api_versions_cnf-low-latency-perf-profile">Supported performance profile API versions</a></li>
<li><a href="#configuring-workload-hints_cnf-low-latency-perf-profile">Configuring node power consumption and realtime processing with workload hints</a></li>
<li><a href="#cnf-configuring-power-saving-for-nodes_cnf-low-latency-perf-profile">Configuring power saving for nodes that run colocated high and low priority workloads</a></li>
<li><a href="#cnf-cpu-infra-container_cnf-low-latency-perf-profile">Restricting CPUs for infra and application containers</a></li>
<li><a href="#cnf-configuring-hyperthreading-for-a-cluster_cnf-low-latency-perf-profile">Configuring Hyper-Threading for a cluster</a>
<ul class="sectlevel2">
<li><a href="#disabling_hyperthreading_for_low_latency_applications_cnf-low-latency-perf-profile">Disabling Hyper-Threading for low latency applications</a></li>
</ul>
</li>
<li><a href="#managing-device-interrupt-processing-for-guaranteed-pod-isolated-cpus_cnf-low-latency-perf-profile">Managing device interrupt processing for guaranteed pod isolated CPUs</a>
<ul class="sectlevel2">
<li><a href="#about_irq_affinity_setting_cnf-low-latency-perf-profile">Finding the effective IRQ affinity setting for a node</a></li>
<li><a href="#configuring_for_irq_dynamic_load_balancing_cnf-low-latency-perf-profile">Configuring node interrupt affinity</a></li>
</ul>
</li>
<li><a href="#cnf-configuring-kernal-page-size_cnf-low-latency-perf-profile">Configuring memory page sizes</a>
<ul class="sectlevel2">
<li><a href="#cnf-page-size-optimization_cnf-low-latency-perf-profile">Configuring kernel page sizes</a></li>
<li><a href="#cnf-configuring-huge-pages_cnf-low-latency-perf-profile">Configuring huge pages</a></li>
<li><a href="#cnf-allocating-multiple-huge-page-sizes_cnf-low-latency-perf-profile">Allocating multiple huge page sizes</a></li>
</ul>
</li>
<li><a href="#cnf-reducing-nic-queues-with-nto">Reducing NIC queues using the Node Tuning Operator</a>
<ul class="sectlevel2">
<li><a href="#adjusting-nic-queues-with-the-performance-profile_cnf-low-latency-perf-profile">Adjusting the NIC queues with the performance profile</a></li>
<li><a href="#verifying-queue-status_cnf-low-latency-perf-profile">Verifying the queue status</a></li>
<li><a href="#logging-associated-with-adjusting-nic-queues_cnf-low-latency-perf-profile">Logging associated with adjusting NIC queues</a></li>
</ul>
</li>
</ul>
</div>
<div class="paragraph">
<p>Tune nodes for low latency by using the cluster performance profile.
You can restrict CPUs for infra and application containers, configure huge pages, Hyper-Threading, and configure CPU partitions for latency-sensitive processes.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cnf-create-performance-profiles"><a class="anchor" href="#cnf-create-performance-profiles"></a>Creating a performance profile</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can create a cluster performance profile by using the Performance Profile Creator (PPC) tool. The PPC is a function of the Node Tuning Operator.</p>
</div>
<div class="paragraph">
<p>The PPC combines information about your cluster with user-supplied configurations to generate a performance profile that is appropriate to your hardware, topology and use-case.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Performance profiles are applicable only to bare-metal environments where the cluster has direct access to the underlying hardware resources. You can configure performances profiles for both single-node OpenShift and multi-node clusters.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following is a high-level workflow for creating and applying a performance profile in your cluster:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a machine config pool (MCP) for nodes that you want to target with performance configurations. In single-node OpenShift clusters, you must use the <code>master</code> MCP because there is only one node in the cluster.</p>
</li>
<li>
<p>Gather information about your cluster using the <code>must-gather</code> command.</p>
</li>
<li>
<p>Use the PPC tool to create a performance profile by using either of the following methods:</p>
<div class="ulist">
<ul>
<li>
<p>Run the PPC tool by using Podman.</p>
</li>
<li>
<p>Run the PPC tool by using a wrapper script.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Configure the performance profile for your use case and apply the performance profile to your cluster.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="cnf-about-the-profile-creator-tool_cnf-low-latency-perf-profile"><a class="anchor" href="#cnf-about-the-profile-creator-tool_cnf-low-latency-perf-profile"></a>About the Performance Profile Creator</h3>
<div class="paragraph">
<p>The Performance Profile Creator (PPC) is a command-line tool, delivered with the Node Tuning Operator, that can help you to create a performance profile for your cluster.</p>
</div>
<div class="paragraph">
<p>Initially, you can use the PPC tool to process the <code>must-gather</code> data to display key performance configurations for your cluster, including the following information:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>NUMA cell partitioning with the allocated CPU IDs</p>
</li>
<li>
<p>Hyper-Threading node configuration</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can use this information to help you configure the performance profile.</p>
</div>
<div class="paragraph">
<div class="title">Running the PPC</div>
<p>Specify performance configuration arguments to the PPC tool to generate a proposed performance profile that is appropriate for your hardware, topology, and use-case.</p>
</div>
<div class="paragraph">
<p>You can run the PPC by using one of the following methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Run the PPC by using Podman</p>
</li>
<li>
<p>Run the PPC by using the wrapper script</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Using the wrapper script abstracts some of the more granular Podman tasks into an executable script. For example, the wrapper script handles tasks such as pulling and running the required container image, mounting directories into the container, and providing parameters directly to the container through Podman. Both methods achieve the same result.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="creating-mcp-for-ppc_cnf-low-latency-perf-profile"><a class="anchor" href="#creating-mcp-for-ppc_cnf-low-latency-perf-profile"></a>Creating a machine config pool to target nodes for performance tuning</h3>
<div class="paragraph">
<p>For multi-node clusters, you can define a machine config pool (MCP) to identify the target nodes that you want to configure with a performance profile.</p>
</div>
<div class="paragraph">
<p>In single-node OpenShift clusters, you must use the <code>master</code> MCP because there is only one node in the cluster. You do not need to create a separate MCP for single-node OpenShift clusters.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have <code>cluster-admin</code> role access.</p>
</li>
<li>
<p>You installed the OpenShift CLI (<code>oc</code>).</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Label the target nodes for configuration by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>oc label node &lt;node_name&gt; node-role.kubernetes.io/worker-cnf<span class="o">=</span><span class="s2">""</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>&lt;node_name&gt;</code> with the name of your node. This example applies the <code>worker-cnf</code> label.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Create a <code>MachineConfigPool</code> resource containing the target nodes:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Create a YAML file that defines the <code>MachineConfigPool</code> resource:</p>
<div class="listingblock">
<div class="title">Example <code>mcp-worker-cnf.yaml</code> file</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">machineconfiguration.openshift.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">MachineConfigPool</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">worker-cnf</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="s">machineconfiguration.openshift.io/role</span><span class="pi">:</span> <span class="s">worker-cnf</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">machineConfigSelector</span><span class="pi">:</span>
    <span class="na">matchExpressions</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="pi">{</span>
           <span class="nv">key</span><span class="pi">:</span> <span class="nv">machineconfiguration.openshift.io/role</span><span class="pi">,</span>
           <span class="nv">operator</span><span class="pi">:</span> <span class="nv">In</span><span class="pi">,</span>
           <span class="nv">values</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">worker</span><span class="pi">,</span> <span class="nv">worker-cnf</span><span class="pi">],</span>
        <span class="pi">}</span>
  <span class="na">paused</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">nodeSelector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="s">node-role.kubernetes.io/worker-cnf</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Specify a name for the <code>MachineConfigPool</code> resource.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specify a unique label for the machine config pool.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Specify the nodes with the target label that you defined.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Apply the <code>MachineConfigPool</code> resource by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>oc apply <span class="nt">-f</span> mcp-worker-cnf.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">machineconfigpool.machineconfiguration.openshift.io/worker-cnf created</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Verification</div>
<ul>
<li>
<p>Check the machine config pools in your cluster by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>oc get mcp</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">NAME         CONFIG                                                 UPDATED   UPDATING   DEGRADED   MACHINECOUNT   READYMACHINECOUNT   UPDATEDMACHINECOUNT   DEGRADEDMACHINECOUNT   AGE
master       rendered-master-58433c7c3c1b4ed5ffef95234d451490       True      False      False      3              3                   3                     0                      6h46m
worker       rendered-worker-168f52b168f151e4f853259729b6azc4       True      False      False      2              2                   2                     0                      6h46m
worker-cnf   rendered-worker-cnf-168f52b168f151e4f853259729b6azc4   True      False      False      1              1                   1                     0                      73s</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="gathering-data-about-your-cluster-using-must-gather_cnf-low-latency-perf-profile"><a class="anchor" href="#gathering-data-about-your-cluster-using-must-gather_cnf-low-latency-perf-profile"></a>Gathering data about your cluster for the PPC</h3>
<div class="paragraph">
<p>The Performance Profile Creator (PPC) tool requires <code>must-gather</code> data. As a cluster administrator, run the <code>must-gather</code> command to capture information about your cluster.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Access to the cluster as a user with the <code>cluster-admin</code> role.</p>
</li>
<li>
<p>You installed the OpenShift CLI (<code>oc</code>).</p>
</li>
<li>
<p>You identified a target MCP that you want to configure with a performance profile.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Navigate to the directory where you want to store the <code>must-gather</code> data.</p>
</li>
<li>
<p>Collect cluster information by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>oc adm must-gather</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command creates a folder with the <code>must-gather</code> data in your local directory with a naming format similar to the following: <code>must-gather.local.1971646453781853027</code>.</p>
</div>
</li>
<li>
<p>Optional: Create a compressed file from the <code>must-gather</code> directory:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span><span class="nb">tar </span>cvaf must-gather.tar.gz &lt;must_gather_folder&gt; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace with the name of the <code>must-gather</code> data folder.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Compressed output is required if you are running the Performance Profile Creator wrapper script.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p>For more information about the <code>must-gather</code> tool,
see <a href="../support/gathering-cluster-data.html#nodes-nodes-managing">Gathering data about your cluster</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="running-the-performance-profile-profile-cluster-using-podman_cnf-low-latency-perf-profile"><a class="anchor" href="#running-the-performance-profile-profile-cluster-using-podman_cnf-low-latency-perf-profile"></a>Running the Performance Profile Creator using Podman</h3>
<div class="paragraph">
<p>As a cluster administrator, you can use Podman with the Performance Profile Creator (PPC) to create a performance profile.</p>
</div>
<div class="paragraph">
<p>For more information about the PPC arguments, see the section <em>"Performance Profile Creator arguments"</em>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The PPC uses the <code>must-gather</code> data from your cluster to create the performance profile. If you make any changes to your cluster, such as relabeling a node targeted for performance configuration, you must re-create the <code>must-gather</code> data before running PPC again.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Access to the cluster as a user with the <code>cluster-admin</code> role.</p>
</li>
<li>
<p>A cluster installed on bare-metal hardware.</p>
</li>
<li>
<p>You installed <code>podman</code> and the OpenShift CLI (<code>oc</code>).</p>
</li>
<li>
<p>Access to the Node Tuning Operator image.</p>
</li>
<li>
<p>You identified a machine config pool containing target nodes for configuration.</p>
</li>
<li>
<p>You have access to the <code>must-gather</code> data for your cluster.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Check the machine config pool by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>oc get mcp</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">NAME         CONFIG                                                 UPDATED   UPDATING   DEGRADED   MACHINECOUNT   READYMACHINECOUNT   UPDATEDMACHINECOUNT   DEGRADEDMACHINECOUNT   AGE
master       rendered-master-58433c8c3c0b4ed5feef95434d455490       True      False      False      3              3                   3                     0                      8h
worker       rendered-worker-668f56a164f151e4a853229729b6adc4       True      False      False      2              2                   2                     0                      8h
worker-cnf   rendered-worker-cnf-668f56a164f151e4a853229729b6adc4   True      False      False      1              1                   1                     0                      79m</span></code></pre>
</div>
</div>
</li>
<li>
<p>Use Podman to authenticate to <code>registry.redhat.io</code> by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>podman login registry.redhat.io</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="bash">Username: &lt;user_name&gt;
Password: &lt;password&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Optional: Display help for the PPC tool by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>podman run <span class="nt">--rm</span> <span class="nt">--entrypoint</span> performance-profile-creator registry.redhat.io/openshift4/ose-cluster-node-tuning-rhel9-operator:vBranch Build <span class="nt">-h</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">A tool that automates creation of Performance Profiles

Usage:
  performance-profile-creator [flags]

Flags:
      --disable-ht                        Disable Hyperthreading
  -h, --help                              help for performance-profile-creator
</span><span class="gp">      --info string                       Show cluster information;</span><span class="w"> </span>requires <span class="nt">--must-gather-dir-path</span>, ignore the other arguments. <span class="o">[</span>Valid values: log, json] <span class="o">(</span>default <span class="s2">"log"</span><span class="o">)</span>
<span class="go">      --mcp-name string                   MCP name corresponding to the target machines (required)
      --must-gather-dir-path string       Must gather directory path (default "must-gather")
      --offlined-cpu-count int            Number of offlined CPUs
      --per-pod-power-management          Enable Per Pod Power Management
      --power-consumption-mode string     The power consumption mode.  [Valid values: default, low-latency, ultra-low-latency] (default "default")
      --profile-name string               Name of the performance profile to be created (default "performance")
      --reserved-cpu-count int            Number of reserved CPUs (required)
      --rt-kernel                         Enable Real Time Kernel (required)
      --split-reserved-cpus-across-numa   Split the Reserved CPUs across NUMA nodes
      --topology-manager-policy string    Kubelet Topology Manager Policy of the performance profile to be created. [Valid values: single-numa-node, best-effort, restricted] (default "restricted")
      --user-level-networking             Run with User level Networking(DPDK) enabled</span></code></pre>
</div>
</div>
</li>
<li>
<p>To display information about the cluster, run the PPC tool with the <code>log</code> argument by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>podman run <span class="nt">--entrypoint</span> performance-profile-creator <span class="nt">-v</span> &lt;path_to_must_gather&gt;:/must-gather:z registry.redhat.io/openshift4/ose-cluster-node-tuning-rhel9-operator:vBranch Build <span class="nt">--info</span> log <span class="nt">--must-gather-dir-path</span> /must-gather</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--entrypoint performance-profile-creator</code> defines the performance profile creator as a new entry point to <code>podman</code>.</p>
</li>
<li>
<p><code>-v &lt;path_to_must_gather&gt;</code> specifies the path to either of the following components:</p>
<div class="ulist">
<ul>
<li>
<p>The directory containing the <code>must-gather</code> data.</p>
</li>
<li>
<p>An existing directory containing the <code>must-gather</code> decompressed .tar file.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>--info log</code> specifies a value for the output format.</p>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">level=info msg="Cluster info:"
level=info msg="MCP 'master' nodes:"
level=info msg=---
level=info msg="MCP 'worker' nodes:"
level=info msg="Node: host.example.com (NUMA cells: 1, HT: true)"
level=info msg="NUMA cell 0 : [0 1 2 3]"
level=info msg="CPU(s): 4"
level=info msg="Node: host1.example.com (NUMA cells: 1, HT: true)"
level=info msg="NUMA cell 0 : [0 1 2 3]"
level=info msg="CPU(s): 4"
level=info msg=---
level=info msg="MCP 'worker-cnf' nodes:"
level=info msg="Node: host2.example.com (NUMA cells: 1, HT: true)"
level=info msg="NUMA cell 0 : [0 1 2 3]"
level=info msg="CPU(s): 4"
level=info msg=---</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Create a performance profile by running the following command. The example uses sample PPC arguments and values:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>podman run <span class="nt">--entrypoint</span> performance-profile-creator <span class="nt">-v</span> &lt;path_to_must_gather&gt;:/must-gather:z registry.redhat.io/openshift4/ose-cluster-node-tuning-rhel9-operator:vBranch Build <span class="nt">--mcp-name</span><span class="o">=</span>worker-cnf <span class="nt">--reserved-cpu-count</span><span class="o">=</span>1 <span class="nt">--rt-kernel</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--split-reserved-cpus-across-numa</span><span class="o">=</span><span class="nb">false</span> <span class="nt">--must-gather-dir-path</span> /must-gather <span class="nt">--power-consumption-mode</span><span class="o">=</span>ultra-low-latency <span class="nt">--offlined-cpu-count</span><span class="o">=</span>1 <span class="o">&gt;</span> my-performance-profile.yaml</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>-v &lt;path_to_must_gather&gt;</code> specifies the path to either of the following components:</p>
<div class="ulist">
<ul>
<li>
<p>The directory containing the <code>must-gather</code> data.</p>
</li>
<li>
<p>The directory containing the <code>must-gather</code> decompressed .tar file.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>--mcp-name=worker-cnf</code> specifies the <code>worker-=cnf</code> machine config pool.</p>
</li>
<li>
<p><code>--reserved-cpu-count=1</code> specifies one reserved CPU.</p>
</li>
<li>
<p><code>--rt-kernel=true</code> enables the real-time kernel.</p>
</li>
<li>
<p><code>--split-reserved-cpus-across-numa=false</code> disables reserved CPUs splitting across NUMA nodes.</p>
</li>
<li>
<p><code>--power-consumption-mode=ultra-low-latency</code> specifies minimal latency at the cost of increased power consumption.</p>
</li>
<li>
<p><code>--offlined-cpu-count=1</code> specifies one offlined CPU.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>mcp-name</code> argument in this example is set to <code>worker-cnf</code> based on the output of the command <code>oc get mcp</code>. For single-node OpenShift use <code>--mcp-name=master</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">level=info msg="Nodes targeted by worker-cnf MCP are: [worker-2]"
level=info msg="NUMA cell(s): 1"
level=info msg="NUMA cell 0 : [0 1 2 3]"
level=info msg="CPU(s): 4"
level=info msg="1 reserved CPUs allocated: 0 "
level=info msg="2 isolated CPUs allocated: 2-3"
level=info msg="Additional Kernel Args based on configuration: []"</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Review the created YAML file by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span><span class="nb">cat </span>my-performance-profile.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">performance.openshift.io/v2</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PerformanceProfile</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">performance</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">cpu</span><span class="pi">:</span>
    <span class="na">isolated</span><span class="pi">:</span> <span class="s">2-3</span>
    <span class="na">offlined</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1"</span>
    <span class="na">reserved</span><span class="pi">:</span> <span class="s2">"</span><span class="s">0"</span>
  <span class="na">machineConfigPoolSelector</span><span class="pi">:</span>
    <span class="s">machineconfiguration.openshift.io/role</span><span class="pi">:</span> <span class="s">worker-cnf</span>
  <span class="na">nodeSelector</span><span class="pi">:</span>
    <span class="s">node-role.kubernetes.io/worker-cnf</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">numa</span><span class="pi">:</span>
    <span class="na">topologyPolicy</span><span class="pi">:</span> <span class="s">restricted</span>
  <span class="na">realTimeKernel</span><span class="pi">:</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">workloadHints</span><span class="pi">:</span>
    <span class="na">highPowerConsumption</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">perPodPowerManagement</span><span class="pi">:</span> <span class="no">false</span>
    <span class="na">realTime</span><span class="pi">:</span> <span class="no">true</span></code></pre>
</div>
</div>
</li>
<li>
<p>Apply the generated profile:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>oc apply <span class="nt">-f</span> my-performance-profile.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">performanceprofile.performance.openshift.io/performance created</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="running-the-performance-profile-creator-wrapper-script_cnf-low-latency-perf-profile"><a class="anchor" href="#running-the-performance-profile-creator-wrapper-script_cnf-low-latency-perf-profile"></a>Running the Performance Profile Creator wrapper script</h3>
<div class="paragraph">
<p>The wrapper script simplifies the process of creating a performance profile with the Performance Profile Creator (PPC) tool. The script handles tasks such as pulling and running the required container image, mounting directories into the container, and providing parameters directly to the container through Podman.</p>
</div>
<div class="paragraph">
<p>For more information about the Performance Profile Creator arguments, see the section <em>"Performance Profile Creator arguments"</em>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The PPC uses the <code>must-gather</code> data from your cluster to create the performance profile. If you make any changes to your cluster, such as relabeling a node targeted for performance configuration, you must re-create the <code>must-gather</code> data before running PPC again.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Access to the cluster as a user with the <code>cluster-admin</code> role.</p>
</li>
<li>
<p>A cluster installed on bare-metal hardware.</p>
</li>
<li>
<p>You installed <code>podman</code> and the OpenShift CLI (<code>oc</code>).</p>
</li>
<li>
<p>Access to the Node Tuning Operator image.</p>
</li>
<li>
<p>You identified a machine config pool containing target nodes for configuration.</p>
</li>
<li>
<p>Access to the <code>must-gather</code> tarball.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a file on your local machine named, for example, <code>run-perf-profile-creator.sh</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>vi run-perf-profile-creator.sh</code></pre>
</div>
</div>
</li>
<li>
<p>Paste the following code into the file:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="bash"><span class="c">#!/bin/bash</span>

<span class="nb">readonly </span><span class="nv">CONTAINER_RUNTIME</span><span class="o">=</span><span class="k">${</span><span class="nv">CONTAINER_RUNTIME</span><span class="k">:-</span><span class="nv">podman</span><span class="k">}</span>
<span class="nb">readonly </span><span class="nv">CURRENT_SCRIPT</span><span class="o">=</span><span class="si">$(</span><span class="nb">basename</span> <span class="s2">"</span><span class="nv">$0</span><span class="s2">"</span><span class="si">)</span>
<span class="nb">readonly </span><span class="nv">CMD</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">CONTAINER_RUNTIME</span><span class="k">}</span><span class="s2"> run --entrypoint performance-profile-creator"</span>
<span class="nb">readonly </span><span class="nv">IMG_EXISTS_CMD</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">CONTAINER_RUNTIME</span><span class="k">}</span><span class="s2"> image exists"</span>
<span class="nb">readonly </span><span class="nv">IMG_PULL_CMD</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">CONTAINER_RUNTIME</span><span class="k">}</span><span class="s2"> image pull"</span>
<span class="nb">readonly </span><span class="nv">MUST_GATHER_VOL</span><span class="o">=</span><span class="s2">"/must-gather"</span>

<span class="nv">NTO_IMG</span><span class="o">=</span><span class="s2">"registry.redhat.io/openshift4/ose-cluster-node-tuning-rhel9-operator:vBranch Build"</span>
<span class="nv">MG_TARBALL</span><span class="o">=</span><span class="s2">""</span>
<span class="nv">DATA_DIR</span><span class="o">=</span><span class="s2">""</span>

usage<span class="o">()</span> <span class="o">{</span>
  print <span class="s2">"Wrapper usage:"</span>
  print <span class="s2">"  </span><span class="k">${</span><span class="nv">CURRENT_SCRIPT</span><span class="k">}</span><span class="s2"> [-h] [-p image][-t path] -- [performance-profile-creator flags]"</span>
  print <span class="s2">""</span>
  print <span class="s2">"Options:"</span>
  print <span class="s2">"   -h                 help for </span><span class="k">${</span><span class="nv">CURRENT_SCRIPT</span><span class="k">}</span><span class="s2">"</span>
  print <span class="s2">"   -p                 Node Tuning Operator image"</span>
  print <span class="s2">"   -t                 path to a must-gather tarball"</span>

  <span class="k">${</span><span class="nv">IMG_EXISTS_CMD</span><span class="k">}</span> <span class="s2">"</span><span class="k">${</span><span class="nv">NTO_IMG</span><span class="k">}</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> <span class="k">${</span><span class="nv">CMD</span><span class="k">}</span> <span class="s2">"</span><span class="k">${</span><span class="nv">NTO_IMG</span><span class="k">}</span><span class="s2">"</span> <span class="nt">-h</span>
<span class="o">}</span>

<span class="k">function </span>cleanup <span class="o">{</span>
  <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="k">${</span><span class="nv">DATA_DIR</span><span class="k">}</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">rm</span> <span class="nt">-rf</span> <span class="s2">"</span><span class="k">${</span><span class="nv">DATA_DIR</span><span class="k">}</span><span class="s2">"</span>
<span class="o">}</span>
<span class="nb">trap </span>cleanup EXIT

exit_error<span class="o">()</span> <span class="o">{</span>
  print <span class="s2">"error: </span><span class="nv">$*</span><span class="s2">"</span>
  usage
  <span class="nb">exit </span>1
<span class="o">}</span>

print<span class="o">()</span> <span class="o">{</span>
  <span class="nb">echo</span>  <span class="s2">"</span><span class="nv">$*</span><span class="s2">"</span> <span class="o">&gt;</span>&amp;2
<span class="o">}</span>

check_requirements<span class="o">()</span> <span class="o">{</span>
  <span class="k">${</span><span class="nv">IMG_EXISTS_CMD</span><span class="k">}</span> <span class="s2">"</span><span class="k">${</span><span class="nv">NTO_IMG</span><span class="k">}</span><span class="s2">"</span> <span class="o">||</span> <span class="k">${</span><span class="nv">IMG_PULL_CMD</span><span class="k">}</span> <span class="s2">"</span><span class="k">${</span><span class="nv">NTO_IMG</span><span class="k">}</span><span class="s2">"</span> <span class="o">||</span> <span class="se">\</span>
      exit_error <span class="s2">"Node Tuning Operator image not found"</span>

  <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MG_TARBALL</span><span class="k">}</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> exit_error <span class="s2">"Must-gather tarball file path is mandatory"</span>
  <span class="o">[</span> <span class="nt">-f</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MG_TARBALL</span><span class="k">}</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> exit_error <span class="s2">"Must-gather tarball file not found"</span>

  <span class="nv">DATA_DIR</span><span class="o">=</span><span class="si">$(</span><span class="nb">mktemp</span> <span class="nt">-d</span> <span class="nt">-t</span> <span class="s2">"</span><span class="k">${</span><span class="nv">CURRENT_SCRIPT</span><span class="k">}</span><span class="s2">XXXX"</span><span class="si">)</span> <span class="o">||</span> exit_error <span class="s2">"Cannot create the data directory"</span>
  <span class="nb">tar</span> <span class="nt">-zxf</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MG_TARBALL</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--directory</span> <span class="s2">"</span><span class="k">${</span><span class="nv">DATA_DIR</span><span class="k">}</span><span class="s2">"</span> <span class="o">||</span> exit_error <span class="s2">"Cannot decompress the must-gather tarball"</span>
  <span class="nb">chmod </span>a+rx <span class="s2">"</span><span class="k">${</span><span class="nv">DATA_DIR</span><span class="k">}</span><span class="s2">"</span>

  <span class="k">return </span>0
<span class="o">}</span>

main<span class="o">()</span> <span class="o">{</span>
  <span class="k">while </span><span class="nb">getopts</span> <span class="s1">':hp:t:'</span> OPT<span class="p">;</span> <span class="k">do
    case</span> <span class="s2">"</span><span class="k">${</span><span class="nv">OPT</span><span class="k">}</span><span class="s2">"</span> <span class="k">in
      </span>h<span class="p">)</span>
        usage
        <span class="nb">exit </span>0
        <span class="p">;;</span>
      p<span class="p">)</span>
        <span class="nv">NTO_IMG</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">OPTARG</span><span class="k">}</span><span class="s2">"</span>
        <span class="p">;;</span>
      t<span class="p">)</span>
        <span class="nv">MG_TARBALL</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">OPTARG</span><span class="k">}</span><span class="s2">"</span>
        <span class="p">;;</span>
      ?<span class="p">)</span>
        exit_error <span class="s2">"invalid argument: </span><span class="k">${</span><span class="nv">OPTARG</span><span class="k">}</span><span class="s2">"</span>
        <span class="p">;;</span>
    <span class="k">esac</span>
  <span class="k">done
  </span><span class="nb">shift</span> <span class="k">$((</span>OPTIND <span class="o">-</span> <span class="m">1</span><span class="k">))</span>

  check_requirements <span class="o">||</span> <span class="nb">exit </span>1

  <span class="k">${</span><span class="nv">CMD</span><span class="k">}</span> <span class="nt">-v</span> <span class="s2">"</span><span class="k">${</span><span class="nv">DATA_DIR</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">MUST_GATHER_VOL</span><span class="k">}</span><span class="s2">:z"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">NTO_IMG</span><span class="k">}</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span> <span class="nt">--must-gather-dir-path</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MUST_GATHER_VOL</span><span class="k">}</span><span class="s2">"</span>
  <span class="nb">echo</span> <span class="s2">""</span> 1&gt;&amp;2
<span class="o">}</span>

main <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span></code></pre>
</div>
</div>
</li>
<li>
<p>Add execute permissions for everyone on this script:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span><span class="nb">chmod </span>a+x run-perf-profile-creator.sh</code></pre>
</div>
</div>
</li>
<li>
<p>Use Podman to authenticate to <code>registry.redhat.io</code> by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>podman login registry.redhat.io</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="bash">Username: &lt;user_name&gt;
Password: &lt;password&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Optional: Display help for the PPC tool by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>./run-perf-profile-creator.sh <span class="nt">-h</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">Wrapper usage:
  run-perf-profile-creator.sh [-h] [-p image][-t path] -- [performance-profile-creator flags]

Options:
   -h                 help for run-perf-profile-creator.sh
   -p                 Node Tuning Operator image
   -t                 path to a must-gather tarball
A tool that automates creation of Performance Profiles

Usage:
  performance-profile-creator [flags]

Flags:
      --disable-ht                        Disable Hyperthreading
  -h, --help                              help for performance-profile-creator
</span><span class="gp">      --info string                       Show cluster information;</span><span class="w"> </span>requires <span class="nt">--must-gather-dir-path</span>, ignore the other arguments. <span class="o">[</span>Valid values: log, json] <span class="o">(</span>default <span class="s2">"log"</span><span class="o">)</span>
<span class="go">      --mcp-name string                   MCP name corresponding to the target machines (required)
      --must-gather-dir-path string       Must gather directory path (default "must-gather")
      --offlined-cpu-count int            Number of offlined CPUs
      --per-pod-power-management          Enable Per Pod Power Management
      --power-consumption-mode string     The power consumption mode.  [Valid values: default, low-latency, ultra-low-latency] (default "default")
      --profile-name string               Name of the performance profile to be created (default "performance")
      --reserved-cpu-count int            Number of reserved CPUs (required)
      --rt-kernel                         Enable Real Time Kernel (required)
      --split-reserved-cpus-across-numa   Split the Reserved CPUs across NUMA nodes
      --topology-manager-policy string    Kubelet Topology Manager Policy of the performance profile to be created. [Valid values: single-numa-node, best-effort, restricted] (default "restricted")
      --user-level-networking             Run with User level Networking(DPDK) enabled
      --enable-hardware-tuning            Enable setting maximum CPU frequencies</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can optionally set a path for the Node Tuning Operator image using the <code>-p</code> option. If you do not set a path, the wrapper script uses the default image: <code>registry.redhat.io/openshift4/ose-cluster-node-tuning-rhel9-operator:vBranch Build</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>To display information about the cluster, run the PPC tool with the <code>log</code> argument by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>./run-perf-profile-creator.sh <span class="nt">-t</span> /&lt;path_to_must_gather_dir&gt;/must-gather.tar.gz <span class="nt">--</span> <span class="nt">--info</span><span class="o">=</span>log</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>-t /&lt;path_to_must_gather_dir&gt;/must-gather.tar.gz</code> specifies the path to directory containing the must-gather tarball. This is a required argument for the wrapper script.</p>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">level=info msg="Cluster info:"
level=info msg="MCP 'master' nodes:"
level=info msg=---
level=info msg="MCP 'worker' nodes:"
level=info msg="Node: host.example.com (NUMA cells: 1, HT: true)"
level=info msg="NUMA cell 0 : [0 1 2 3]"
level=info msg="CPU(s): 4"
level=info msg="Node: host1.example.com (NUMA cells: 1, HT: true)"
level=info msg="NUMA cell 0 : [0 1 2 3]"
level=info msg="CPU(s): 4"
level=info msg=---
level=info msg="MCP 'worker-cnf' nodes:"
level=info msg="Node: host2.example.com (NUMA cells: 1, HT: true)"
level=info msg="NUMA cell 0 : [0 1 2 3]"
level=info msg="CPU(s): 4"
level=info msg=---</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Create a performance profile by running the following command.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>./run-perf-profile-creator.sh <span class="nt">-t</span> /path-to-must-gather/must-gather.tar.gz <span class="nt">--</span> <span class="nt">--mcp-name</span><span class="o">=</span>worker-cnf <span class="nt">--reserved-cpu-count</span><span class="o">=</span>1 <span class="nt">--rt-kernel</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--split-reserved-cpus-across-numa</span><span class="o">=</span><span class="nb">false</span> <span class="nt">--power-consumption-mode</span><span class="o">=</span>ultra-low-latency <span class="nt">--offlined-cpu-count</span><span class="o">=</span>1 <span class="o">&gt;</span> my-performance-profile.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example uses sample PPC arguments and values.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--mcp-name=worker-cnf</code> specifies the <code>worker-=cnf</code> machine config pool.</p>
</li>
<li>
<p><code>--reserved-cpu-count=1</code> specifies one reserved CPU.</p>
</li>
<li>
<p><code>--rt-kernel=true</code> enables the real-time kernel.</p>
</li>
<li>
<p><code>--split-reserved-cpus-across-numa=false</code> disables reserved CPUs splitting across NUMA nodes.</p>
</li>
<li>
<p><code>--power-consumption-mode=ultra-low-latency</code> specifies minimal latency at the cost of increased power consumption.</p>
</li>
<li>
<p><code>--offlined-cpu-count=1</code> specifies one offlined CPUs.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>mcp-name</code> argument in this example is set to <code>worker-cnf</code> based on the output of the command <code>oc get mcp</code>. For single-node OpenShift use <code>--mcp-name=master</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Review the created YAML file by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span><span class="nb">cat </span>my-performance-profile.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">performance.openshift.io/v2</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PerformanceProfile</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">performance</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">cpu</span><span class="pi">:</span>
    <span class="na">isolated</span><span class="pi">:</span> <span class="s">2-3</span>
    <span class="na">offlined</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1"</span>
    <span class="na">reserved</span><span class="pi">:</span> <span class="s2">"</span><span class="s">0"</span>
  <span class="na">machineConfigPoolSelector</span><span class="pi">:</span>
    <span class="s">machineconfiguration.openshift.io/role</span><span class="pi">:</span> <span class="s">worker-cnf</span>
  <span class="na">nodeSelector</span><span class="pi">:</span>
    <span class="s">node-role.kubernetes.io/worker-cnf</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">numa</span><span class="pi">:</span>
    <span class="na">topologyPolicy</span><span class="pi">:</span> <span class="s">restricted</span>
  <span class="na">realTimeKernel</span><span class="pi">:</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">workloadHints</span><span class="pi">:</span>
    <span class="na">highPowerConsumption</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">perPodPowerManagement</span><span class="pi">:</span> <span class="no">false</span>
    <span class="na">realTime</span><span class="pi">:</span> <span class="no">true</span></code></pre>
</div>
</div>
</li>
<li>
<p>Apply the generated profile:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>oc apply <span class="nt">-f</span> my-performance-profile.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">performanceprofile.performance.openshift.io/performance created</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="performance-profile-creator-arguments_cnf-low-latency-perf-profile"><a class="anchor" href="#performance-profile-creator-arguments_cnf-low-latency-perf-profile"></a>Performance Profile Creator arguments</h3>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Required Performance Profile Creator arguments</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Argument</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mcp-name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name for MCP; for example, <code>worker-cnf</code> corresponding to the target machines.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>must-gather-dir-path</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The path of the must gather directory.</p>
<p class="tableblock">This argument is only required if you run the PPC tool by using Podman. If you use the PPC with the wrapper script, do not use this argument. Instead, specify the directory path to the <code>must-gather</code> tarball by using the <code>-t</code> option for the wrapper script.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>reserved-cpu-count</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of reserved CPUs. Use a natural number greater than zero.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rt-kernel</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables real-time kernel.</p>
<p class="tableblock">Possible values: <code>true</code> or <code>false</code>.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Optional Performance Profile Creator arguments</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Argument</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>disable-ht</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Disable Hyper-Threading.</p>
</div>
<div class="paragraph">
<p>Possible values: <code>true</code> or <code>false</code>.</p>
</div>
<div class="paragraph">
<p>Default: <code>false</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If this argument is set to <code>true</code> you should not disable Hyper-Threading in the BIOS. Disabling Hyper-Threading is accomplished with a kernel command line argument.</p>
</div>
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">enable-hardware-tuning</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Enable the setting of maximum CPU frequencies.</p>
</div>
<div class="paragraph">
<p>To enable this feature, set the maximum frequency for applications running on isolated and reserved CPUs for both of the following fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>spec.hardwareTuning.isolatedCpuFreq</code></p>
</li>
<li>
<p><code>spec.hardwareTuning.reservedCpuFreq</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is an advanced feature. If you configure hardware tuning, the generated <code>PerformanceProfile</code> includes warnings and guidance on how to set frequency settings.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>info</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>This captures cluster information. This argument also requires the <code>must-gather-dir-path</code> argument. If any other arguments are set they are ignored.</p>
</div>
<div class="paragraph">
<p>Possible values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>log</code></p>
</li>
<li>
<p><code>JSON</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Default: <code>log</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>offlined-cpu-count</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Number of offlined CPUs.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Use a natural number greater than zero. If not enough logical processors are offlined, then error messages are logged. The messages are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">Error: failed to compute the reserved and isolated CPUs: please ensure that reserved-cpu-count plus offlined-cpu-count should be in the range [0,1]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">Error: failed to compute the reserved and isolated CPUs: please specify the offlined CPU count in the range [0,1]</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>power-consumption-mode</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The power consumption mode.</p>
</div>
<div class="paragraph">
<p>Possible values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>default</code>: Performance achieved through CPU partitioning only.</p>
</li>
<li>
<p><code>low-latency</code>: Enhanced measures to improve latency.</p>
</li>
<li>
<p><code>ultra-low-latency</code>: Priority given to optimal latency, at the expense of power management.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Default: <code>default</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>per-pod-power-management</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Enable per pod power management. You cannot use this argument if you configured <code>ultra-low-latency</code> as the power consumption mode.</p>
</div>
<div class="paragraph">
<p>Possible values: <code>true</code> or <code>false</code>.</p>
</div>
<div class="paragraph">
<p>Default: <code>false</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>profile-name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the performance profile to create.</p>
<p class="tableblock">Default: <code>performance</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>split-reserved-cpus-across-numa</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Split the reserved CPUs across NUMA nodes.</p>
<p class="tableblock">Possible values: <code>true</code> or <code>false</code>.</p>
<p class="tableblock">Default: <code>false</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>topology-manager-policy</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Kubelet Topology Manager policy of the performance profile to be created.</p>
</div>
<div class="paragraph">
<p>Possible values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>single-numa-node</code></p>
</li>
<li>
<p><code>best-effort</code></p>
</li>
<li>
<p><code>restricted</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Default: <code>restricted</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>user-level-networking</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Run with user level networking (DPDK) enabled.</p>
<p class="tableblock">Possible values: <code>true</code> or <code>false</code>.</p>
<p class="tableblock">Default: <code>false</code>.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="cnf-create-performance-profiles-reference"><a class="anchor" href="#cnf-create-performance-profiles-reference"></a>Reference performance profiles</h3>
<div class="paragraph">
<p>Use the following reference performance profiles as the basis to develop your own custom profiles.</p>
</div>
<div class="sect3">
<h4 id="installation-openstack-ovs-dpdk-performance-profile_cnf-low-latency-perf-profile"><a class="anchor" href="#installation-openstack-ovs-dpdk-performance-profile_cnf-low-latency-perf-profile"></a>Performance profile template for clusters that use OVS-DPDK on OpenStack</h4>
<div class="paragraph">
<p>To maximize machine performance in a cluster that uses Open vSwitch with the Data Plane Development Kit (OVS-DPDK) on Red Hat OpenStack Platform (RHOSP), you can use a performance profile.</p>
</div>
<div class="paragraph">
<p>You can use the following performance profile template to create a profile for your deployment.</p>
</div>
<div class="listingblock">
<div class="title">Performance profile template for clusters that use OVS-DPDK</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">performance.openshift.io/v2</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PerformanceProfile</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">cnf-performanceprofile</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">additionalKernelArgs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">nmi_watchdog=0</span>
    <span class="pi">-</span> <span class="s">audit=0</span>
    <span class="pi">-</span> <span class="s">mce=off</span>
    <span class="pi">-</span> <span class="s">processor.max_cstate=1</span>
    <span class="pi">-</span> <span class="s">idle=poll</span>
    <span class="pi">-</span> <span class="s">intel_idle.max_cstate=0</span>
    <span class="pi">-</span> <span class="s">default_hugepagesz=1GB</span>
    <span class="pi">-</span> <span class="s">hugepagesz=1G</span>
    <span class="pi">-</span> <span class="s">intel_iommu=on</span>
  <span class="na">cpu</span><span class="pi">:</span>
    <span class="na">isolated</span><span class="pi">:</span> <span class="s">&lt;CPU_ISOLATED&gt;</span>
    <span class="na">reserved</span><span class="pi">:</span> <span class="s">&lt;CPU_RESERVED&gt;</span>
  <span class="na">hugepages</span><span class="pi">:</span>
    <span class="na">defaultHugepagesSize</span><span class="pi">:</span> <span class="s">1G</span>
    <span class="na">pages</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">count</span><span class="pi">:</span> <span class="s">&lt;HUGEPAGES_COUNT&gt;</span>
        <span class="na">node</span><span class="pi">:</span> <span class="m">0</span>
        <span class="na">size</span><span class="pi">:</span> <span class="s">1G</span>
  <span class="na">nodeSelector</span><span class="pi">:</span>
    <span class="s">node-role.kubernetes.io/worker</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>
  <span class="na">globallyDisableIrqLoadBalancing</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">realTimeKernel</span><span class="pi">:</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">false</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Insert values that are appropriate for your configuration for the <code>CPU_ISOLATED</code>, <code>CPU_RESERVED</code>, and <code>HUGEPAGES_COUNT</code> keys.</p>
</div>
</div>
<div class="sect3">
<h4 id="cnf-telco-ran-reference-design-performance-profile-template_cnf-low-latency-perf-profile"><a class="anchor" href="#cnf-telco-ran-reference-design-performance-profile-template_cnf-low-latency-perf-profile"></a>Telco RAN DU reference design performance profile</h4>
<div class="paragraph">
<p>The following performance profile configures node-level performance settings for OpenShift Container Platform clusters on commodity hardware to host telco RAN DU workloads.</p>
</div>
<div class="listingblock">
<div class="title">Telco RAN DU reference design performance profile</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">performance.openshift.io/v2</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PerformanceProfile</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="c1"># if you change this name make sure the 'include' line in TunedPerformancePatch.yaml</span>
  <span class="c1"># matches this name: include=openshift-node-performance-${PerformanceProfile.metadata.name}</span>
  <span class="c1"># Also in file 'validatorCRs/informDuValidator.yaml': </span>
  <span class="c1"># name: 50-performance-${PerformanceProfile.metadata.name}</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">openshift-node-performance-profile</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="s">ran.openshift.io/reference-configuration</span><span class="pi">:</span> <span class="s2">"</span><span class="s">ran-du.redhat.com"</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">additionalKernelArgs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">rcupdate.rcu_normal_after_boot=0"</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">efi=runtime"</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">vfio_pci.enable_sriov=1"</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">vfio_pci.disable_idle_d3=1"</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">module_blacklist=irdma"</span>
  <span class="na">cpu</span><span class="pi">:</span>
    <span class="na">isolated</span><span class="pi">:</span> <span class="s">$isolated</span>
    <span class="na">reserved</span><span class="pi">:</span> <span class="s">$reserved</span>
  <span class="na">hugepages</span><span class="pi">:</span>
    <span class="na">defaultHugepagesSize</span><span class="pi">:</span> <span class="s">$defaultHugepagesSize</span>
    <span class="na">pages</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">size</span><span class="pi">:</span> <span class="s">$size</span>
        <span class="na">count</span><span class="pi">:</span> <span class="s">$count</span>
        <span class="na">node</span><span class="pi">:</span> <span class="s">$node</span>
  <span class="na">machineConfigPoolSelector</span><span class="pi">:</span>
    <span class="s">pools.operator.machineconfiguration.openshift.io/$mcp</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">nodeSelector</span><span class="pi">:</span>
    <span class="s">node-role.kubernetes.io/$mcp</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>
  <span class="na">numa</span><span class="pi">:</span>
    <span class="na">topologyPolicy</span><span class="pi">:</span> <span class="s2">"</span><span class="s">restricted"</span>
  <span class="c1"># To use the standard (non-realtime) kernel, set enabled to false</span>
  <span class="na">realTimeKernel</span><span class="pi">:</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">workloadHints</span><span class="pi">:</span>
    <span class="c1"># WorkloadHints defines the set of upper level flags for different type of workloads.</span>
    <span class="c1"># See https://github.com/openshift/cluster-node-tuning-operator/blob/master/docs/performanceprofile/performance_profile.md#workloadhints</span>
    <span class="c1"># for detailed descriptions of each item.</span>
    <span class="c1"># The configuration below is set for a low latency, performance mode.</span>
    <span class="na">realTime</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">highPowerConsumption</span><span class="pi">:</span> <span class="no">false</span>
    <span class="na">perPodPowerManagement</span><span class="pi">:</span> <span class="no">false</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cnf-telco-core-reference-design-performance-profile-template_cnf-low-latency-perf-profile"><a class="anchor" href="#cnf-telco-core-reference-design-performance-profile-template_cnf-low-latency-perf-profile"></a>Telco core reference design performance profile</h4>
<div class="paragraph">
<p>The following performance profile configures node-level performance settings for OpenShift Container Platform clusters on commodity hardware to host telco core workloads.</p>
</div>
<div class="listingblock">
<div class="title">Telco core reference design performance profile</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">performance.openshift.io/v2</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PerformanceProfile</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="c1"># if you change this name make sure the 'include' line in TunedPerformancePatch.yaml</span>
  <span class="c1"># matches this name: include=openshift-node-performance-${PerformanceProfile.metadata.name}</span>
  <span class="c1"># Also in file 'validatorCRs/informDuValidator.yaml': </span>
  <span class="c1"># name: 50-performance-${PerformanceProfile.metadata.name}</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">openshift-node-performance-profile</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="s">ran.openshift.io/reference-configuration</span><span class="pi">:</span> <span class="s2">"</span><span class="s">ran-du.redhat.com"</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">additionalKernelArgs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">rcupdate.rcu_normal_after_boot=0"</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">efi=runtime"</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">vfio_pci.enable_sriov=1"</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">vfio_pci.disable_idle_d3=1"</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">module_blacklist=irdma"</span>
  <span class="na">cpu</span><span class="pi">:</span>
    <span class="na">isolated</span><span class="pi">:</span> <span class="s">$isolated</span>
    <span class="na">reserved</span><span class="pi">:</span> <span class="s">$reserved</span>
  <span class="na">hugepages</span><span class="pi">:</span>
    <span class="na">defaultHugepagesSize</span><span class="pi">:</span> <span class="s">$defaultHugepagesSize</span>
    <span class="na">pages</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">size</span><span class="pi">:</span> <span class="s">$size</span>
        <span class="na">count</span><span class="pi">:</span> <span class="s">$count</span>
        <span class="na">node</span><span class="pi">:</span> <span class="s">$node</span>
  <span class="na">machineConfigPoolSelector</span><span class="pi">:</span>
    <span class="s">pools.operator.machineconfiguration.openshift.io/$mcp</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">nodeSelector</span><span class="pi">:</span>
    <span class="s">node-role.kubernetes.io/$mcp</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>
  <span class="na">numa</span><span class="pi">:</span>
    <span class="na">topologyPolicy</span><span class="pi">:</span> <span class="s2">"</span><span class="s">restricted"</span>
  <span class="c1"># To use the standard (non-realtime) kernel, set enabled to false</span>
  <span class="na">realTimeKernel</span><span class="pi">:</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">workloadHints</span><span class="pi">:</span>
    <span class="c1"># WorkloadHints defines the set of upper level flags for different type of workloads.</span>
    <span class="c1"># See https://github.com/openshift/cluster-node-tuning-operator/blob/master/docs/performanceprofile/performance_profile.md#workloadhints</span>
    <span class="c1"># for detailed descriptions of each item.</span>
    <span class="c1"># The configuration below is set for a low latency, performance mode.</span>
    <span class="na">realTime</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">highPowerConsumption</span><span class="pi">:</span> <span class="no">false</span>
    <span class="na">perPodPowerManagement</span><span class="pi">:</span> <span class="no">false</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="nto_supported_api_versions_cnf-low-latency-perf-profile"><a class="anchor" href="#nto_supported_api_versions_cnf-low-latency-perf-profile"></a>Supported performance profile API versions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Node Tuning Operator supports <code>v2</code>, <code>v1</code>, and <code>v1alpha1</code> for the performance profile <code>apiVersion</code> field. The v1 and v1alpha1 APIs are identical. The v2 API includes an optional boolean field <code>globallyDisableIrqLoadBalancing</code> with a default value of <code>false</code>.</p>
</div>
<h3 id="use-device-interrupt-processing-for-isolated-cpus_cnf-low-latency-perf-profile" class="discrete">Upgrading the performance profile to use device interrupt processing</h3>
<div class="paragraph">
<p>When you upgrade the Node Tuning Operator performance profile custom resource definition (CRD) from v1 or v1alpha1 to v2, <code>globallyDisableIrqLoadBalancing</code> is set to <code>true</code> on existing profiles.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>globallyDisableIrqLoadBalancing</code> toggles whether IRQ load balancing will be disabled for the Isolated CPU set. When the option is set to <code>true</code> it disables IRQ load balancing for the Isolated CPU set. Setting the option to <code>false</code> allows the IRQs to be balanced across all CPUs.</p>
</div>
</td>
</tr>
</table>
</div>
<h4 id="upgrading_nto_api_from_v1alpha1_to_v1_cnf-low-latency-perf-profile" class="discrete">Upgrading Node Tuning Operator API from v1alpha1 to v1</h4>
<div class="paragraph">
<p>When upgrading Node Tuning Operator API version from v1alpha1 to v1, the v1alpha1 performance profiles are converted on-the-fly using a "None" Conversion strategy and served to the Node Tuning Operator with API version v1.</p>
</div>
<h4 id="upgrading_nto_api_from_v1alpha1_to_v1_or_v2_cnf-low-latency-perf-profile" class="discrete">Upgrading Node Tuning Operator API from v1alpha1 or v1 to v2</h4>
<div class="paragraph">
<p>When upgrading from an older Node Tuning Operator API version, the existing v1 and v1alpha1 performance profiles are converted using a conversion webhook that injects the <code>globallyDisableIrqLoadBalancing</code> field with a value of <code>true</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-workload-hints_cnf-low-latency-perf-profile"><a class="anchor" href="#configuring-workload-hints_cnf-low-latency-perf-profile"></a>Configuring node power consumption and realtime processing with workload hints</h2>
<div class="sectionbody">
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Create a <code>PerformanceProfile</code> appropriate for the environment&#8217;s hardware and topology by using the Performance Profile Creator (PPC) tool. The following table describes the possible values set for the <code>power-consumption-mode</code> flag associated with the PPC tool and the workload hint that is applied.</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Impact of combinations of power consumption and real-time settings on latency</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Performance Profile creator setting</th>
<th class="tableblock halign-left valign-top">Hint</th>
<th class="tableblock halign-left valign-top">Environment</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">workloadHints:
highPowerConsumption: false
realTime: false</span></code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">High throughput cluster without latency requirements</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Performance achieved through CPU partitioning only.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Low-latency</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">workloadHints:
highPowerConsumption: false
realTime: true</span></code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Regional data-centers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Both energy savings and low-latency are desirable: compromise between power management, latency and throughput.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ultra-low-latency</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">workloadHints:
highPowerConsumption: true
realTime: true</span></code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Far edge clusters, latency critical workloads</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optimized for absolute minimal latency and maximum determinism at the cost of increased power consumption.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Per-pod power management</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">workloadHints:
realTime: true
highPowerConsumption: false
perPodPowerManagement: true</span></code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Critical and non-critical workloads</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows for power management per pod.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Example</div>
<p>The following configuration is commonly used in a telco RAN DU deployment.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml">    <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">performance.openshift.io/v2</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">PerformanceProfile</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">workload-hints</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="s">...</span>
      <span class="s">workloadHints</span><span class="pi">:</span>
        <span class="na">realTime</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">highPowerConsumption</span><span class="pi">:</span> <span class="no">false</span>
        <span class="na">perPodPowerManagement</span><span class="pi">:</span> <span class="no">false</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Disables some debugging and monitoring features that can affect system latency.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When the <code>realTime</code> workload hint flag is set to <code>true</code> in a performance profile, add the <code>cpu-quota.crio.io: disable</code> annotation to every guaranteed pod with pinned CPUs. This annotation is necessary to prevent the degradation of the process performance within the pod. If the <code>realTime</code> workload hint is not explicitly set, it defaults to <code>true</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For more information how combinations of power consumption and real-time settings impact latency, see <a href="https://access.redhat.com/articles/7081587">Understanding workload hints</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cnf-configuring-power-saving-for-nodes_cnf-low-latency-perf-profile"><a class="anchor" href="#cnf-configuring-power-saving-for-nodes_cnf-low-latency-perf-profile"></a>Configuring power saving for nodes that run colocated high and low priority workloads</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can enable power savings for a node that has low priority workloads that are colocated with high priority workloads without impacting the latency or throughput of the high priority workloads. Power saving is possible without modifications to the workloads themselves.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The feature is supported on Intel Ice Lake and later generations of Intel CPUs. The capabilities of the processor might impact the latency and throughput of the high priority workloads.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You enabled C-states and operating system controlled P-states in the BIOS</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Generate a <code>PerformanceProfile</code> with the <code>per-pod-power-management</code> argument set to <code>true</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>podman run <span class="nt">--entrypoint</span> performance-profile-creator <span class="nt">-v</span> <span class="se">\</span>
/must-gather:/must-gather:z registry.redhat.io/openshift4/ose-cluster-node-tuning-rhel9-operator:vBranch Build <span class="se">\</span>
<span class="nt">--mcp-name</span><span class="o">=</span>worker-cnf <span class="nt">--reserved-cpu-count</span><span class="o">=</span>20 <span class="nt">--rt-kernel</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--split-reserved-cpus-across-numa</span><span class="o">=</span><span class="nb">false</span> <span class="nt">--topology-manager-policy</span><span class="o">=</span>single-numa-node <span class="se">\</span>
<span class="nt">--must-gather-dir-path</span> /must-gather <span class="nt">--power-consumption-mode</span><span class="o">=</span>low-latency <span class="se">\ </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="gp">--per-pod-power-management=true &gt;</span><span class="w"> </span>my-performance-profile.yaml</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>power-consumption-mode</code> argument must be <code>default</code> or <code>low-latency</code> when the <code>per-pod-power-management</code> argument is set to <code>true</code>.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example <code>PerformanceProfile</code> with <code>perPodPowerManagement</code></div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">performance.openshift.io/v2</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PerformanceProfile</span>
<span class="na">metadata</span><span class="pi">:</span>
     <span class="na">name</span><span class="pi">:</span> <span class="s">performance</span>
<span class="na">spec</span><span class="pi">:</span>
    <span class="pi">[</span><span class="nv">.....</span><span class="pi">]</span>
    <span class="na">workloadHints</span><span class="pi">:</span>
        <span class="na">realTime</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">highPowerConsumption</span><span class="pi">:</span> <span class="no">false</span>
        <span class="na">perPodPowerManagement</span><span class="pi">:</span> <span class="no">true</span></code></pre>
</div>
</div>
</li>
<li>
<p>Set the default <code>cpufreq</code> governor as an additional kernel argument in the <code>PerformanceProfile</code> custom resource (CR):</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">performance.openshift.io/v2</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PerformanceProfile</span>
<span class="na">metadata</span><span class="pi">:</span>
     <span class="na">name</span><span class="pi">:</span> <span class="s">performance</span>
<span class="na">spec</span><span class="pi">:</span>
    <span class="s">...</span>
    <span class="s">additionalKernelArgs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">cpufreq.default_governor=schedutil</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Using the <code>schedutil</code> governor is recommended, however, you can use other governors such as the <code>ondemand</code> or <code>powersave</code> governors.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Set the maximum CPU frequency in the <code>TunedPerformancePatch</code> CR:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">spec</span><span class="pi">:</span>
  <span class="na">profile</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">data</span><span class="pi">:</span> <span class="pi">|</span>
      <span class="s">[sysfs]</span>
      <span class="s">/sys/devices/system/cpu/intel_pstate/max_perf_pct = &lt;x&gt; </span><i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>max_perf_pct</code> controls the maximum frequency that the <code>cpufreq</code> driver is allowed to set as a percentage of the maximum supported cpu frequency. This value applies to all CPUs. You can check the maximum supported frequency in <code>/sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_max_freq</code>. As a starting point, you can use a percentage that caps all CPUs at the <code>All Cores Turbo</code> frequency. The <code>All Cores Turbo</code> frequency is the frequency that all cores will run at when the cores are all fully occupied.</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="../scalability_and_performance/cnf-tuning-low-latency-nodes-with-perf-profile.html#cnf-about-the-profile-creator-tool_cnf-low-latency-perf-profile">About the Performance Profile Creator</a></p>
</li>
<li>
<p><a href="../scalability_and_performance/cnf-provisioning-low-latency-workloads.html#cnf-configuring-high-priority-workload-pods_cnf-provisioning-low-latency">Disabling power saving mode for high priority pods</a></p>
</li>
<li>
<p><a href="../scalability_and_performance/cnf-tuning-low-latency-nodes-with-perf-profile.html#managing-device-interrupt-processing-for-guaranteed-pod-isolated-cpus_cnf-low-latency-perf-profile">Managing device interrupt processing for guaranteed pod isolated CPUs</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cnf-cpu-infra-container_cnf-low-latency-perf-profile"><a class="anchor" href="#cnf-cpu-infra-container_cnf-low-latency-perf-profile"></a>Restricting CPUs for infra and application containers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Generic housekeeping and workload tasks use CPUs in a way that may impact latency-sensitive processes. By default, the container runtime uses all online CPUs to run all containers together, which can result in context switches and spikes in latency. Partitioning the CPUs prevents noisy processes from interfering with latency-sensitive processes by separating them from each other. The following table describes how processes run on a CPU after you have tuned the node using the Node Tuning Operator:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Process' CPU assignments</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Process type</th>
<th class="tableblock halign-left valign-top">Details</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Burstable</code> and <code>BestEffort</code> pods</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Runs on any CPU except where low latency workload is running</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infrastructure pods</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Runs on any CPU except where low latency workload is running</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interrupts</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Redirects to reserved CPUs (optional in OpenShift Container Platform 4.7 and later)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kernel processes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pins to reserved CPUs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Latency-sensitive workload pods</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pins to a specific set of exclusive CPUs from the isolated pool</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OS processes/systemd services</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pins to reserved CPUs</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The allocatable capacity of cores on a node for pods of all QoS process types, <code>Burstable</code>,  <code>BestEffort</code>, or <code>Guaranteed</code>, is equal to the capacity of the isolated pool. The capacity of the reserved pool is removed from the node&#8217;s total core capacity for use by the cluster and operating system housekeeping duties.</p>
</div>
<div class="paragraph">
<div class="title">Example 1</div>
<p>A node features a capacity of 100 cores. Using a performance profile, the cluster administrator allocates 50 cores to the isolated pool and 50 cores to the reserved pool. The cluster administrator assigns 25 cores to QoS <code>Guaranteed</code> pods and 25 cores for <code>BestEffort</code> or <code>Burstable</code> pods. This matches the capacity of the isolated pool.</p>
</div>
<div class="paragraph">
<div class="title">Example 2</div>
<p>A node features a capacity of 100 cores. Using a performance profile, the cluster administrator allocates 50 cores to the isolated pool and 50 cores to the reserved pool. The cluster administrator assigns 50 cores to QoS <code>Guaranteed</code> pods and one core for <code>BestEffort</code> or <code>Burstable</code> pods. This exceeds the capacity of the isolated pool by one core. Pod scheduling fails because of insufficient CPU capacity.</p>
</div>
<div class="paragraph">
<p>The exact partitioning pattern to use depends on many factors like hardware, workload characteristics and the expected system load. Some sample use cases are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the latency-sensitive workload uses specific hardware, such as a network interface controller (NIC), ensure that the CPUs in the isolated pool are as close as possible to this hardware. At a minimum, you should place the workload in the same Non-Uniform Memory Access (NUMA) node.</p>
</li>
<li>
<p>The reserved pool is used for handling all interrupts. When depending on system networking, allocate a sufficiently-sized reserve pool to handle all the incoming packet interrupts. In Branch Build and later versions, workloads can optionally be labeled as sensitive.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The decision regarding which specific CPUs should be used for reserved and isolated partitions requires detailed analysis and measurements. Factors like NUMA affinity of devices and memory play a role. The selection also depends on the workload architecture and the specific use case.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The reserved and isolated CPU pools must not overlap and together must span all available cores in the worker node.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To ensure that housekeeping tasks and workloads do not interfere with each other, specify two groups of CPUs in the <code>spec</code> section of the performance profile.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>isolated</code> - Specifies the CPUs for the application container workloads. These CPUs have the lowest latency. Processes in this group have no interruptions and can, for example, reach much higher DPDK zero packet loss bandwidth.</p>
</li>
<li>
<p><code>reserved</code> - Specifies the CPUs for the cluster and operating system housekeeping duties. Threads in the <code>reserved</code> group are often busy. Do not run latency-sensitive applications in the <code>reserved</code> group. Latency-sensitive applications run in the <code>isolated</code> group.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a performance profile appropriate for the environment&#8217;s hardware and topology.</p>
</li>
<li>
<p>Add the <code>reserved</code> and <code>isolated</code> parameters with the CPUs you want reserved and isolated for the infra and application containers:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="s">apiVersion</span><span class="pi">:</span> <span class="s">performance.openshift.io/v2</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PerformanceProfile</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">infra-cpus</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">cpu</span><span class="pi">:</span>
    <span class="na">reserved</span><span class="pi">:</span> <span class="s2">"</span><span class="s">0-4,9"</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="na">isolated</span><span class="pi">:</span> <span class="s2">"</span><span class="s">5-8"</span> <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="na">nodeSelector</span><span class="pi">:</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="s">node-role.kubernetes.io/worker</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Specify which CPUs are for infra containers to perform cluster and operating system housekeeping duties.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specify which CPUs are for application containers to run workloads.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Optional: Specify a node selector to apply the performance profile to specific nodes.</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cnf-configuring-hyperthreading-for-a-cluster_cnf-low-latency-perf-profile"><a class="anchor" href="#cnf-configuring-hyperthreading-for-a-cluster_cnf-low-latency-perf-profile"></a>Configuring Hyper-Threading for a cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To configure Hyper-Threading for an OpenShift Container Platform cluster, set the CPU threads in the performance profile to the same cores that are configured for the reserved or isolated CPU pools.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you configure a performance profile, and subsequently change the Hyper-Threading configuration for the host, ensure that you update the CPU <code>isolated</code> and <code>reserved</code> fields in the <code>PerformanceProfile</code> YAML to match the new configuration.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Disabling a previously enabled host Hyper-Threading configuration can cause the CPU core IDs listed in the <code>PerformanceProfile</code> YAML to be incorrect. This incorrect configuration can cause the node to become unavailable because the listed CPUs can no longer be found.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Access to the cluster as a user with the <code>cluster-admin</code> role.</p>
</li>
<li>
<p>Install the OpenShift CLI (oc).</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Ascertain which threads are running on what CPUs for the host you want to configure.</p>
<div class="paragraph">
<p>You can view which threads are running on the host CPUs by logging in to the cluster and running the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>lscpu <span class="nt">--all</span> <span class="nt">--extended</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">CPU NODE SOCKET CORE L1d:L1i:L2:L3 ONLINE MAXMHZ    MINMHZ
0   0    0      0    0:0:0:0       yes    4800.0000 400.0000
1   0    0      1    1:1:1:0       yes    4800.0000 400.0000
2   0    0      2    2:2:2:0       yes    4800.0000 400.0000
3   0    0      3    3:3:3:0       yes    4800.0000 400.0000
4   0    0      0    0:0:0:0       yes    4800.0000 400.0000
5   0    0      1    1:1:1:0       yes    4800.0000 400.0000
6   0    0      2    2:2:2:0       yes    4800.0000 400.0000
7   0    0      3    3:3:3:0       yes    4800.0000 400.0000</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, there are eight logical CPU cores running on four physical CPU cores. CPU0 and CPU4 are running on physical Core0, CPU1 and CPU5 are running on physical Core 1, and so on.</p>
</div>
<div class="paragraph">
<p>Alternatively, to view the threads that are set for a particular physical CPU core (<code>cpu0</code> in the example below), open a shell prompt and run the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span><span class="nb">cat</span> /sys/devices/system/cpu/cpu0/topology/thread_siblings_list</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">0-4</span></code></pre>
</div>
</div>
</li>
<li>
<p>Apply the isolated and reserved CPUs in the <code>PerformanceProfile</code> YAML. For example, you can set logical cores CPU0 and CPU4 as <code>isolated</code>, and logical cores CPU1 to CPU3 and CPU5 to CPU7 as <code>reserved</code>. When you configure reserved and isolated CPUs, the infra containers in pods use the reserved CPUs and the application containers use the isolated CPUs.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="nn">...</span>
  <span class="na">cpu</span><span class="pi">:</span>
    <span class="na">isolated</span><span class="pi">:</span> <span class="s">0,4</span>
    <span class="na">reserved</span><span class="pi">:</span> <span class="s">1-3,5-7</span>
<span class="nn">...</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The reserved and isolated CPU pools must not overlap and together must span all available cores in the worker node.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Hyper-Threading is enabled by default on most Intel processors. If you enable Hyper-Threading, all threads processed by a particular core must be isolated or processed on the same core.</p>
</div>
<div class="paragraph">
<p>When Hyper-Threading is enabled, all guaranteed pods must use multiples of the simultaneous multi-threading (SMT) level to avoid a "noisy neighbor" situation that can cause the pod to fail.
See <a href="https://kubernetes.io/docs/tasks/administer-cluster/cpu-management-policies/#static-policy-options">Static policy options</a> for more information.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="disabling_hyperthreading_for_low_latency_applications_cnf-low-latency-perf-profile"><a class="anchor" href="#disabling_hyperthreading_for_low_latency_applications_cnf-low-latency-perf-profile"></a>Disabling Hyper-Threading for low latency applications</h3>
<div class="paragraph">
<p>When configuring clusters for low latency processing, consider whether you want to disable Hyper-Threading before you deploy the cluster. To disable Hyper-Threading, perform the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a performance profile that is appropriate for your hardware and topology.</p>
</li>
<li>
<p>Set <code>nosmt</code> as an additional kernel argument. The following example performance profile illustrates this setting:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">performance.openshift.io/v2</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PerformanceProfile</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">example-performanceprofile</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">additionalKernelArgs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">nmi_watchdog=0</span>
    <span class="pi">-</span> <span class="s">audit=0</span>
    <span class="pi">-</span> <span class="s">mce=off</span>
    <span class="pi">-</span> <span class="s">processor.max_cstate=1</span>
    <span class="pi">-</span> <span class="s">idle=poll</span>
    <span class="pi">-</span> <span class="s">intel_idle.max_cstate=0</span>
    <span class="pi">-</span> <span class="s">nosmt</span>
  <span class="na">cpu</span><span class="pi">:</span>
    <span class="na">isolated</span><span class="pi">:</span> <span class="s">2-3</span>
    <span class="na">reserved</span><span class="pi">:</span> <span class="s">0-1</span>
  <span class="na">hugepages</span><span class="pi">:</span>
    <span class="na">defaultHugepagesSize</span><span class="pi">:</span> <span class="s">1G</span>
    <span class="na">pages</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">count</span><span class="pi">:</span> <span class="m">2</span>
        <span class="na">node</span><span class="pi">:</span> <span class="m">0</span>
        <span class="na">size</span><span class="pi">:</span> <span class="s">1G</span>
  <span class="na">nodeSelector</span><span class="pi">:</span>
    <span class="s">node-role.kubernetes.io/performance</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>
  <span class="na">realTimeKernel</span><span class="pi">:</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When you configure reserved and isolated CPUs, the infra containers in pods use the reserved CPUs and the application containers use the isolated CPUs.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="managing-device-interrupt-processing-for-guaranteed-pod-isolated-cpus_cnf-low-latency-perf-profile"><a class="anchor" href="#managing-device-interrupt-processing-for-guaranteed-pod-isolated-cpus_cnf-low-latency-perf-profile"></a>Managing device interrupt processing for guaranteed pod isolated CPUs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Node Tuning Operator can manage host CPUs by dividing them into reserved CPUs for cluster and operating system housekeeping duties, including pod infra containers, and isolated CPUs for application containers to run the workloads. This allows you to set CPUs for low latency workloads as isolated.</p>
</div>
<div class="paragraph">
<p>Device interrupts are load balanced between all isolated and reserved CPUs to avoid CPUs being overloaded, with the exception of CPUs where there is a guaranteed pod running. Guaranteed pod CPUs are prevented from processing device interrupts when the relevant annotations are set for the pod.</p>
</div>
<div class="paragraph">
<p>In the performance profile, <code>globallyDisableIrqLoadBalancing</code> is used to manage whether device interrupts are processed or not. For certain workloads, the reserved CPUs are not always sufficient for dealing with device interrupts, and for this reason, device interrupts are not globally disabled on the isolated CPUs. By default, Node Tuning Operator does not disable device interrupts on isolated CPUs.</p>
</div>
<div class="sect2">
<h3 id="about_irq_affinity_setting_cnf-low-latency-perf-profile"><a class="anchor" href="#about_irq_affinity_setting_cnf-low-latency-perf-profile"></a>Finding the effective IRQ affinity setting for a node</h3>
<div class="paragraph">
<p>Some IRQ controllers lack support for IRQ affinity setting and will always expose all online CPUs as the IRQ mask. These IRQ controllers effectively run on CPU 0.</p>
</div>
<div class="paragraph">
<p>The following are examples of drivers and hardware that Red Hat are aware lack support for IRQ affinity setting. The list is, by no means, exhaustive:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some RAID controller drivers, such as <code>megaraid_sas</code></p>
</li>
<li>
<p>Many non-volatile memory express (NVMe) drivers</p>
</li>
<li>
<p>Some LAN on motherboard (LOM) network controllers</p>
</li>
<li>
<p>The driver uses <code>managed_irqs</code></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The reason they do not support IRQ affinity setting might be associated with factors such as the type of processor, the IRQ controller, or the circuitry connections in the motherboard.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If the effective affinity of any IRQ is set to an isolated CPU, it might be a sign of some hardware or driver not supporting IRQ affinity setting. To find the effective affinity, log in to the host and run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>find /proc/irq <span class="nt">-name</span> effective_affinity <span class="nt">-printf</span> <span class="s2">"%p: "</span> <span class="nt">-exec</span> <span class="nb">cat</span> <span class="o">{}</span> <span class="se">\;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">/proc/irq/0/effective_affinity: 1
/proc/irq/1/effective_affinity: 8
/proc/irq/2/effective_affinity: 0
/proc/irq/3/effective_affinity: 1
/proc/irq/4/effective_affinity: 2
/proc/irq/5/effective_affinity: 1
/proc/irq/6/effective_affinity: 1
/proc/irq/7/effective_affinity: 1
/proc/irq/8/effective_affinity: 1
/proc/irq/9/effective_affinity: 2
/proc/irq/10/effective_affinity: 1
/proc/irq/11/effective_affinity: 1
/proc/irq/12/effective_affinity: 4
/proc/irq/13/effective_affinity: 1
/proc/irq/14/effective_affinity: 1
/proc/irq/15/effective_affinity: 1
/proc/irq/24/effective_affinity: 2
/proc/irq/25/effective_affinity: 4
/proc/irq/26/effective_affinity: 2
/proc/irq/27/effective_affinity: 1
/proc/irq/28/effective_affinity: 8
/proc/irq/29/effective_affinity: 4
/proc/irq/30/effective_affinity: 4
/proc/irq/31/effective_affinity: 8
/proc/irq/32/effective_affinity: 8
/proc/irq/33/effective_affinity: 1
/proc/irq/34/effective_affinity: 2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Some drivers use <code>managed_irqs</code>, whose affinity is managed internally by the kernel and userspace cannot change the affinity. In some cases, these IRQs might be assigned to isolated CPUs. For more information about <code>managed_irqs</code>, see <a href="https://access.redhat.com/solutions/4819541">Affinity of managed interrupts cannot be changed even if they target isolated CPU</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="configuring_for_irq_dynamic_load_balancing_cnf-low-latency-perf-profile"><a class="anchor" href="#configuring_for_irq_dynamic_load_balancing_cnf-low-latency-perf-profile"></a>Configuring node interrupt affinity</h3>
<div class="paragraph">
<p>Configure a cluster node for IRQ dynamic load balancing to control which cores can receive device interrupt requests (IRQ).</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>For core isolation, all server hardware components must support IRQ affinity. To check if the hardware components of your server support IRQ affinity, view the server&#8217;s hardware specifications or contact your hardware provider.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to the OpenShift Container Platform cluster as a user with cluster-admin privileges.</p>
</li>
<li>
<p>Set the performance profile <code>apiVersion</code> to use <code>performance.openshift.io/v2</code>.</p>
</li>
<li>
<p>Remove the <code>globallyDisableIrqLoadBalancing</code> field or set it to <code>false</code>.</p>
</li>
<li>
<p>Set the appropriate isolated and reserved CPUs. The following snippet illustrates a profile that reserves 2 CPUs. IRQ load-balancing is enabled for pods running on the <code>isolated</code> CPU set:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">performance.openshift.io/v2</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PerformanceProfile</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">dynamic-irq-profile</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">cpu</span><span class="pi">:</span>
    <span class="na">isolated</span><span class="pi">:</span> <span class="s">2-5</span>
    <span class="na">reserved</span><span class="pi">:</span> <span class="s">0-1</span>
<span class="nn">...</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When you configure reserved and isolated CPUs, operating system processes, kernel processes, and systemd services run on reserved CPUs.
Infrastructure pods run on any CPU except where the low latency workload is running.
Low latency workload pods run on exclusive CPUs from the isolated pool.
For more information, see "Restricting CPUs for infra and application containers".</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cnf-configuring-kernal-page-size_cnf-low-latency-perf-profile"><a class="anchor" href="#cnf-configuring-kernal-page-size_cnf-low-latency-perf-profile"></a>Configuring memory page sizes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By configuring memory page sizes, system administrators can implement more efficient memory management on a specific node to suit workload requirements. The Node Tuning Operator provides a method for configuring huge pages and kernel page sizes by using a performance profile.</p>
</div>
<div class="sect2">
<h3 id="cnf-page-size-optimization_cnf-low-latency-perf-profile"><a class="anchor" href="#cnf-page-size-optimization_cnf-low-latency-perf-profile"></a>Configuring kernel page sizes</h3>
<div class="paragraph">
<p>Use the <code>kernelPageSize</code> specification in a performance profile to configure the kernel page size on a specific node. Specify larger kernel page sizes for memory-intensive, high-performance workloads.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For nodes with an x86_64 or AMD64 architecture, you can only specify <code>4k</code> for the <code>kernelPageSize</code> specification. For nodes with an AArch64 architecture, you can specify <code>4k</code> or <code>64k</code> for the <code>kernelPageSize</code> specification. The default value is <code>4k</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Access to the cluster as a user with the <code>cluster-admin</code> role.</p>
</li>
<li>
<p>Install the OpenShift CLI (<code>oc</code>).</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a performance profile to target nodes where you want to configure the kernel page size by creating a YAML file that defines the <code>PerformanceProfile</code> resource:</p>
<div class="listingblock">
<div class="title">Example <code>pp-kernel-pages.yaml</code> file</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">performance.openshift.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PerformanceProfile</span>
<span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">example-performance-profile</span>
<span class="c1">#...</span>
<span class="na">spec</span><span class="pi">:</span>
    <span class="na">kernelPageSize</span><span class="pi">:</span> <span class="s2">"</span><span class="s">64k"</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="na">nodeSelector</span><span class="pi">:</span>
        <span class="s">node-role.kubernetes.io/worker</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This example specifies a kernel page size of <code>64k</code>. You can only specify <code>64k</code> for nodes with an AArch64 architecture. The default value is <code>4k</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This example targets nodes with the <code>worker</code> role.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Apply the performance profile to the cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="bash"><span class="nv">$ </span>oc create <span class="nt">-f</span> pp-kernel-pages.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="nowrap">performanceprofile.performance.openshift.io/example-performance-profile created</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">Verification</div>
<ol class="arabic">
<li>
<p>Start a debug session on the node where you applied the performance profile by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="bash"><span class="nv">$ </span>oc debug node/&lt;node_name&gt; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>&lt;node_name&gt;</code> with the name of the node with the performance profile applied.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Verify that the kernel page size is set to the value you specified in the performance profile by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="bash"><span class="nv">$ </span>getconf PAGESIZE</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="nowrap">65536</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="cnf-configuring-huge-pages_cnf-low-latency-perf-profile"><a class="anchor" href="#cnf-configuring-huge-pages_cnf-low-latency-perf-profile"></a>Configuring huge pages</h3>
<div class="paragraph">
<p>Nodes must pre-allocate huge pages used in an OpenShift Container Platform cluster. Use the Node Tuning Operator to allocate huge pages on a specific node.</p>
</div>
<div class="paragraph">
<p>OpenShift Container Platform provides a method for creating and allocating huge pages. Node Tuning Operator provides an easier method for doing  this using the performance profile.</p>
</div>
<div class="paragraph">
<p>For example, in the <code>hugepages</code> <code>pages</code> section of the performance profile, you can specify multiple blocks of <code>size</code>, <code>count</code>, and, optionally, <code>node</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">hugepages</span><span class="pi">:</span>
   <span class="na">defaultHugepagesSize</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1G"</span>
   <span class="na">pages</span><span class="pi">:</span>
   <span class="pi">-</span> <span class="na">size</span><span class="pi">:</span>  <span class="s2">"</span><span class="s">1G"</span>
     <span class="na">count</span><span class="pi">:</span>  <span class="m">4</span>
     <span class="na">node</span><span class="pi">:</span>  <span class="s">0</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>node</code> is the NUMA node in which the huge pages are allocated. If you omit <code>node</code>, the pages are evenly spread across all NUMA nodes.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Wait for the relevant machine config pool status that indicates the update is finished.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>These are the only configuration steps you need to do to allocate huge pages.</p>
</div>
<div class="ulist">
<div class="title">Verification</div>
<ul>
<li>
<p>To verify the configuration, see the <code>/proc/meminfo</code> file on the node:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>oc debug node/ip-10-0-141-105.ec2.internal</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">#</span><span class="w"> </span><span class="nb">grep</span> <span class="nt">-i</span> huge /proc/meminfo</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">AnonHugePages:    #</span><span class="c">##### ##</span>
<span class="go">ShmemHugePages:        0 kB
HugePages_Total:       2
HugePages_Free:        2
HugePages_Rsvd:        0
HugePages_Surp:        0
</span><span class="gp">Hugepagesize:       #</span><span class="c">### ##</span>
<span class="gp">Hugetlb:            #</span><span class="c">### ##</span></code></pre>
</div>
</div>
</li>
<li>
<p>Use <code>oc describe</code> to report the new size:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>oc describe node worker-0.ocp4poc.example.com | <span class="nb">grep</span> <span class="nt">-i</span> huge</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">                                   hugepages-1g=true
</span><span class="gp"> hugepages-#</span><span class="c">##:  ###</span>
<span class="gp"> hugepages-#</span><span class="c">##:  ###</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="cnf-allocating-multiple-huge-page-sizes_cnf-low-latency-perf-profile"><a class="anchor" href="#cnf-allocating-multiple-huge-page-sizes_cnf-low-latency-perf-profile"></a>Allocating multiple huge page sizes</h3>
<div class="paragraph">
<p>You can request huge pages with different sizes under the same container. This allows you to define more complicated pods consisting of containers with different huge page size needs.</p>
</div>
<div class="paragraph">
<p>For example, you can define sizes <code>1G</code> and <code>2M</code> and the Node Tuning Operator will configure both sizes on the node, as shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">spec</span><span class="pi">:</span>
  <span class="na">hugepages</span><span class="pi">:</span>
    <span class="na">defaultHugepagesSize</span><span class="pi">:</span> <span class="s">1G</span>
    <span class="na">pages</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">count</span><span class="pi">:</span> <span class="m">1024</span>
      <span class="na">node</span><span class="pi">:</span> <span class="m">0</span>
      <span class="na">size</span><span class="pi">:</span> <span class="s">2M</span>
    <span class="pi">-</span> <span class="na">count</span><span class="pi">:</span> <span class="m">4</span>
      <span class="na">node</span><span class="pi">:</span> <span class="m">1</span>
      <span class="na">size</span><span class="pi">:</span> <span class="s">1G</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cnf-reducing-nic-queues-with-nto"><a class="anchor" href="#cnf-reducing-nic-queues-with-nto"></a>Reducing NIC queues using the Node Tuning Operator</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Node Tuning Operator facilitates reducing NIC queues for enhanced performance.
Adjustments are made using the performance profile, allowing customization of queues for different network devices.</p>
</div>
<div class="sect2">
<h3 id="adjusting-nic-queues-with-the-performance-profile_cnf-low-latency-perf-profile"><a class="anchor" href="#adjusting-nic-queues-with-the-performance-profile_cnf-low-latency-perf-profile"></a>Adjusting the NIC queues with the performance profile</h3>
<div class="paragraph">
<p>The performance profile lets you adjust the queue count for each network device.</p>
</div>
<div class="paragraph">
<p>Supported network devices:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Non-virtual network devices</p>
</li>
<li>
<p>Network devices that support multiple queues (channels)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Unsupported network devices:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pure software network interfaces</p>
</li>
<li>
<p>Block devices</p>
</li>
<li>
<p>Intel DPDK virtual functions</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Access to the cluster as a user with the <code>cluster-admin</code> role.</p>
</li>
<li>
<p>Install the OpenShift CLI (<code>oc</code>).</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to the OpenShift Container Platform cluster running the Node Tuning Operator as a user with <code>cluster-admin</code> privileges.</p>
</li>
<li>
<p>Create and apply a performance profile appropriate for your hardware and topology. For guidance on creating a profile, see the "Creating a performance profile" section.</p>
</li>
<li>
<p>Edit this created performance profile:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>oc edit <span class="nt">-f</span> &lt;your_profile_name&gt;.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Populate the <code>spec</code> field with the <code>net</code> object. The object list can contain two fields:</p>
<div class="ulist">
<ul>
<li>
<p><code>userLevelNetworking</code> is a required field specified as a boolean flag. If <code>userLevelNetworking</code> is <code>true</code>, the queue count is set to the reserved CPU count for all supported devices. The default is <code>false</code>.</p>
</li>
<li>
<p><code>devices</code> is an optional field specifying a list of devices that will have the queues set to the reserved CPU count. If the device list is empty, the configuration applies to all network devices. The configuration is as follows:</p>
<div class="ulist">
<ul>
<li>
<p><code>interfaceName</code>: This field specifies the interface name, and it supports shell-style wildcards, which can be positive or negative.</p>
<div class="ulist">
<ul>
<li>
<p>Example wildcard syntax is as follows: <code>&lt;string&gt; .*</code></p>
</li>
<li>
<p>Negative rules are prefixed with an exclamation mark. To apply the net queue changes to all devices other than the excluded list, use  <code>!&lt;device&gt;</code>, for example, <code>!eno1</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>vendorID</code>: The network device vendor ID represented as a 16-bit hexadecimal number with a <code>0x</code> prefix.</p>
</li>
<li>
<p><code>deviceID</code>: The network device ID (model) represented as a 16-bit hexadecimal number with a <code>0x</code> prefix.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When a <code>deviceID</code> is specified, the <code>vendorID</code> must also be defined. A device that matches all of the device identifiers specified in a device entry <code>interfaceName</code>, <code>vendorID</code>, or a pair of <code>vendorID</code> plus <code>deviceID</code> qualifies as a network device. This network device then has its net queues count set to the reserved CPU count.</p>
</div>
<div class="paragraph">
<p>When two or more devices are specified, the net queues count is set to any net device that matches one of them.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Set the queue count to the reserved CPU count for all devices by using this example performance profile:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">performance.openshift.io/v2</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PerformanceProfile</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">manual</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">cpu</span><span class="pi">:</span>
    <span class="na">isolated</span><span class="pi">:</span> <span class="s">3-51,55-103</span>
    <span class="na">reserved</span><span class="pi">:</span> <span class="s">0-2,52-54</span>
  <span class="na">net</span><span class="pi">:</span>
    <span class="na">userLevelNetworking</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">nodeSelector</span><span class="pi">:</span>
    <span class="s">node-role.kubernetes.io/worker-cnf</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span></code></pre>
</div>
</div>
</li>
<li>
<p>Set the queue count to the reserved CPU count for all devices matching any of the defined device identifiers by using this example performance profile:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">performance.openshift.io/v2</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PerformanceProfile</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">manual</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">cpu</span><span class="pi">:</span>
    <span class="na">isolated</span><span class="pi">:</span> <span class="s">3-51,55-103</span>
    <span class="na">reserved</span><span class="pi">:</span> <span class="s">0-2,52-54</span>
  <span class="na">net</span><span class="pi">:</span>
    <span class="na">userLevelNetworking</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">devices</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">interfaceName</span><span class="pi">:</span> <span class="s2">"</span><span class="s">eth0"</span>
    <span class="pi">-</span> <span class="na">interfaceName</span><span class="pi">:</span> <span class="s2">"</span><span class="s">eth1"</span>
    <span class="pi">-</span> <span class="na">vendorID</span><span class="pi">:</span> <span class="s2">"</span><span class="s">0x1af4"</span>
      <span class="na">deviceID</span><span class="pi">:</span> <span class="s2">"</span><span class="s">0x1000"</span>
  <span class="na">nodeSelector</span><span class="pi">:</span>
    <span class="s">node-role.kubernetes.io/worker-cnf</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span></code></pre>
</div>
</div>
</li>
<li>
<p>Set the queue count to the reserved CPU count for all devices starting with the interface name <code>eth</code> by using this example performance profile:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">performance.openshift.io/v2</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PerformanceProfile</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">manual</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">cpu</span><span class="pi">:</span>
    <span class="na">isolated</span><span class="pi">:</span> <span class="s">3-51,55-103</span>
    <span class="na">reserved</span><span class="pi">:</span> <span class="s">0-2,52-54</span>
  <span class="na">net</span><span class="pi">:</span>
    <span class="na">userLevelNetworking</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">devices</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">interfaceName</span><span class="pi">:</span> <span class="s2">"</span><span class="s">eth*"</span>
  <span class="na">nodeSelector</span><span class="pi">:</span>
    <span class="s">node-role.kubernetes.io/worker-cnf</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span></code></pre>
</div>
</div>
</li>
<li>
<p>Set the queue count to the reserved CPU count for all devices with an interface named anything other than <code>eno1</code> by using this example performance profile:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">performance.openshift.io/v2</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PerformanceProfile</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">manual</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">cpu</span><span class="pi">:</span>
    <span class="na">isolated</span><span class="pi">:</span> <span class="s">3-51,55-103</span>
    <span class="na">reserved</span><span class="pi">:</span> <span class="s">0-2,52-54</span>
  <span class="na">net</span><span class="pi">:</span>
    <span class="na">userLevelNetworking</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">devices</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">interfaceName</span><span class="pi">:</span> <span class="s2">"</span><span class="s">!eno1"</span>
  <span class="na">nodeSelector</span><span class="pi">:</span>
    <span class="s">node-role.kubernetes.io/worker-cnf</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span></code></pre>
</div>
</div>
</li>
<li>
<p>Set the queue count to the reserved CPU count for all devices that have an interface name <code>eth0</code>, <code>vendorID</code> of <code>0x1af4</code>, and <code>deviceID</code> of <code>0x1000</code> by using this example performance profile:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">performance.openshift.io/v2</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PerformanceProfile</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">manual</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">cpu</span><span class="pi">:</span>
    <span class="na">isolated</span><span class="pi">:</span> <span class="s">3-51,55-103</span>
    <span class="na">reserved</span><span class="pi">:</span> <span class="s">0-2,52-54</span>
  <span class="na">net</span><span class="pi">:</span>
    <span class="na">userLevelNetworking</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">devices</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">interfaceName</span><span class="pi">:</span> <span class="s2">"</span><span class="s">eth0"</span>
    <span class="pi">-</span> <span class="na">vendorID</span><span class="pi">:</span> <span class="s2">"</span><span class="s">0x1af4"</span>
      <span class="na">deviceID</span><span class="pi">:</span> <span class="s2">"</span><span class="s">0x1000"</span>
  <span class="na">nodeSelector</span><span class="pi">:</span>
    <span class="s">node-role.kubernetes.io/worker-cnf</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span></code></pre>
</div>
</div>
</li>
<li>
<p>Apply the updated performance profile:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>oc apply <span class="nt">-f</span> &lt;your_profile_name&gt;.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="../scalability_and_performance/cnf-tuning-low-latency-nodes-with-perf-profile.html#cnf-create-performance-profiles">Creating a performance profile</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="verifying-queue-status_cnf-low-latency-perf-profile"><a class="anchor" href="#verifying-queue-status_cnf-low-latency-perf-profile"></a>Verifying the queue status</h3>
<div class="paragraph">
<p>In this section, a number of examples illustrate different performance profiles and how to verify the changes are applied.</p>
</div>
<div class="paragraph">
<div class="title">Example 1</div>
<p>In this example, the net queue count is set to the reserved CPU count (2) for <em>all</em> supported devices.</p>
</div>
<div class="paragraph">
<p>The relevant section from the performance profile is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">performance.openshift.io/v2</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">performance</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">PerformanceProfile</span>
  <span class="na">spec</span><span class="pi">:</span>
    <span class="na">cpu</span><span class="pi">:</span>
      <span class="na">reserved</span><span class="pi">:</span> <span class="s">0-1</span>  <span class="c1">#total = 2</span>
      <span class="na">isolated</span><span class="pi">:</span> <span class="s">2-8</span>
    <span class="na">net</span><span class="pi">:</span>
      <span class="na">userLevelNetworking</span><span class="pi">:</span> <span class="no">true</span>
<span class="c1"># ...</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Display the status of the queues associated with a device using the following command:</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Run this command on the node where the performance profile was applied.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>ethtool <span class="nt">-l</span> &lt;device&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Verify the queue status before the profile is applied:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>ethtool <span class="nt">-l</span> ens4</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">Channel parameters for ens4:
Pre-set maximums:
RX:         0
TX:         0
Other:      0
Combined:   4
Current hardware settings:
RX:         0
TX:         0
Other:      0
Combined:   4</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verify the queue status after the profile is applied:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>ethtool <span class="nt">-l</span> ens4</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">Channel parameters for ens4:
Pre-set maximums:
RX:         0
TX:         0
Other:      0
Combined:   4
Current hardware settings:
RX:         0
TX:         0
Other:      0
Combined:   2 <i class="conum" data-value="1"></i><b>(1)</b>
</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The combined channel shows that the total count of reserved CPUs for <em>all</em> supported devices is 2. This matches what is configured in the performance profile.</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Example 2</div>
<p>In this example, the net queue count is set to the reserved CPU count (2) for <em>all</em> supported network devices with a specific <code>vendorID</code>.</p>
</div>
<div class="paragraph">
<p>The relevant section from the performance profile is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">performance.openshift.io/v2</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">performance</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">PerformanceProfile</span>
  <span class="na">spec</span><span class="pi">:</span>
    <span class="na">cpu</span><span class="pi">:</span>
      <span class="na">reserved</span><span class="pi">:</span> <span class="s">0-1</span>  <span class="c1">#total = 2</span>
      <span class="na">isolated</span><span class="pi">:</span> <span class="s">2-8</span>
    <span class="na">net</span><span class="pi">:</span>
      <span class="na">userLevelNetworking</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">devices</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">vendorID = 0x1af4</span>
<span class="c1"># ...</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Display the status of the queues associated with a device using the following command:</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Run this command on the node where the performance profile was applied.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>ethtool <span class="nt">-l</span> &lt;device&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Verify the queue status after the profile is applied:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>ethtool <span class="nt">-l</span> ens4</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">Channel parameters for ens4:
Pre-set maximums:
RX:         0
TX:         0
Other:      0
Combined:   4
Current hardware settings:
RX:         0
TX:         0
Other:      0
Combined:   2 <i class="conum" data-value="1"></i><b>(1)</b>
</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The total count of reserved CPUs for all supported devices with <code>vendorID=0x1af4</code> is 2.
For example, if there is another network device <code>ens2</code> with <code>vendorID=0x1af4</code> it will also have total net queues of 2. This matches what is configured in the performance profile.</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Example 3</div>
<p>In this example, the net queue count is set to the reserved CPU count (2) for <em>all</em> supported network devices that match any of the defined device identifiers.</p>
</div>
<div class="paragraph">
<p>The command <code>udevadm info</code> provides a detailed report on a device. In this example the devices are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">#</span><span class="w"> </span>udevadm info <span class="nt">-p</span> /sys/class/net/ens4
<span class="c">...
</span><span class="go">E: ID_MODEL_ID=0x1000
E: ID_VENDOR_ID=0x1af4
E: INTERFACE=ens4
</span><span class="c">...</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">#</span><span class="w"> </span>udevadm info <span class="nt">-p</span> /sys/class/net/eth0
<span class="c">...
</span><span class="go">E: ID_MODEL_ID=0x1002
E: ID_VENDOR_ID=0x1001
E: INTERFACE=eth0
</span><span class="c">...</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Set the net queues to 2 for a device with <code>interfaceName</code> equal to <code>eth0</code> and any devices that have a <code>vendorID=0x1af4</code> with the following performance profile:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">performance.openshift.io/v2</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">performance</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">PerformanceProfile</span>
    <span class="s">spec</span><span class="pi">:</span>
      <span class="na">cpu</span><span class="pi">:</span>
        <span class="na">reserved</span><span class="pi">:</span> <span class="s">0-1</span>  <span class="c1">#total = 2</span>
        <span class="na">isolated</span><span class="pi">:</span> <span class="s">2-8</span>
      <span class="na">net</span><span class="pi">:</span>
        <span class="na">userLevelNetworking</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">devices</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">interfaceName = eth0</span>
        <span class="pi">-</span> <span class="s">vendorID = 0x1af4</span>
<span class="nn">...</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verify the queue status after the profile is applied:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="gp">$</span><span class="w"> </span>ethtool <span class="nt">-l</span> ens4</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">Channel parameters for ens4:
Pre-set maximums:
RX:         0
TX:         0
Other:      0
Combined:   4
Current hardware settings:
RX:         0
TX:         0
Other:      0
Combined:   2 <i class="conum" data-value="1"></i><b>(1)</b>
</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The total count of reserved CPUs for all supported devices with <code>vendorID=0x1af4</code> is set to 2.
For example, if there is another network device <code>ens2</code> with <code>vendorID=0x1af4</code>, it will also have the total net queues set to 2. Similarly, a device with <code>interfaceName</code> equal to <code>eth0</code> will have total net queues set to 2.</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="logging-associated-with-adjusting-nic-queues_cnf-low-latency-perf-profile"><a class="anchor" href="#logging-associated-with-adjusting-nic-queues_cnf-low-latency-perf-profile"></a>Logging associated with adjusting NIC queues</h3>
<div class="paragraph">
<p>Log messages detailing the assigned devices are recorded in the respective Tuned daemon logs. The following messages might be recorded to the <code>/var/log/tuned/tuned.log</code> file:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An <code>INFO</code> message is recorded detailing the successfully assigned devices:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">INFO tuned.plugins.base: instance net_test (net): assigning devices ens1, ens2, ens3</span></code></pre>
</div>
</div>
</li>
<li>
<p>A <code>WARNING</code> message is recorded if none of the devices can be assigned:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="terminal"><span class="go">WARNING  tuned.plugins.base: instance net_test: no matching devices available</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
      </div>
    </div>
  </div>
  <script src="https://assets.openshift.net/content/modernizr.js" type="text/javascript"></script>
  <script src="https://assets.openshift.net/content/subdomain.js" type="text/javascript"></script>
  <script src="https://assets.openshift.net/content/nav-tertiary.js" type="text/javascript"></script>
  <script src="https://docs.okd.io/latest/_javascripts/bootstrap-offcanvas.js" type="text/javascript"></script>
  <script src="https://docs.okd.io/latest/_javascripts/reformat-html.js" type="text/javascript"></script>
  <script src="https://docs.okd.io/latest/_javascripts/hc-search.js" type="text/javascript"></script>
  <script src="https://docs.okd.io/latest/_javascripts/page-loader.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" type="text/javascript"></script>
  <script src="https://docs.okd.io/latest/_javascripts/clipboard.js" type="text/javascript"></script>
  <script src="https://docs.okd.io/latest/_javascripts/collapsible.js" type="text/javascript"></script>
  <script>
  var dk = 'openshift-dpu';
  var version = 'Branch Build';

  var distros = {
    'openshift-origin': ['docs_origin', version],
    // specific labels are used for OSD instead of the URL filter, due to its unusual URL structure; assume v4
    'openshift-dedicated': ['docs_dedicated_v4'],
    'openshift-online': ['docs_online', version],
    'openshift-enterprise': ['docs_cp', version],
    'openshift-telco': ['docs_telco', version],
    'openshift-aro' : ['docs_aro', version],
    'openshift-rosa' : ['docs_rosa'],
    'openshift-acs' : ['docs_acs', version],
    'openshift-serverless' : ['docs_serverless', version],
    'openshift-pipelines' : ['docs_pipelines', version],
    'openshift-builds' : ['docs_builds', version],
    'openshift-gitops' : ['docs_gitops', version],
    'openshift-lightspeed' : ['docs_lightspeed', version],
    'openshift-service-mesh' : ['docs_service_mesh', version]
  };

  // only OSD v3 docs have the version variable specified
  if (dk == "openshift-dedicated" && version == "3") {
    distros['openshift-dedicated'] = ['docs_dedicated_v3']
  }

  distros[dk] ? hcSearchCategory.apply(null, distros[dk]) : hcSearchCategory("docs");
  </script>
  <script type="text/javascript">
  /*<![CDATA[*/
  $(document).ready(function() {
    $("[id^='topicGroup']").on('show.bs.collapse', function(event) {
      if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
        $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
      }
    });
    $("[id^='topicGroup']").on('hide.bs.collapse', function(event) {
      if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
        $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
      }
    });
    $("[id^='topicSubGroup']").on('show.bs.collapse', function() {
      $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
    });
    $("[id^='topicSubGroup']").on('hide.bs.collapse', function() {
      $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
    });
    $("[id^='topicSubSubGroup']").on('show.bs.collapse', function() {
      $(this).parent().find("[id^='ssgSpan']").toggleClass("fa-caret-right fa-caret-down");
    });
    $("[id^='topicSubSubGroup']").on('hide.bs.collapse', function() {
      $(this).parent().find("[id^='ssgSpan']").toggleClass("fa-caret-right fa-caret-down");
    });

    const collapsibleContent = document.getElementsByTagName("details");
    for (var i = 0; i < collapsibleContent.length; i++) {
      collapsibleContent[i].setAttribute("open", "");
    }

  });
  /*]]>*/
  </script>

  <footer id="rh">

    <div class="container">
        <div class="row">

            <div class="col-sm-2">
                <img src="https://assets.openshift.net/content/img/Logo-Red_Hat-OpenShift-A-Reverse-RGB.svg" class="img-fluid" alt="Red Hat" style="height: 30px;">
            </div>

            <div class="col-sm-3">
              <p class="text-nowrap">Copyright  2025 Red Hat, Inc.</p>
            </div>



            <div class="col">
                <nav class="nav">
                    <a target="_blank" href="https://www.redhat.com/en/about/privacy-policy" class="nav-link">Privacy statement</a>
                    <a target="_blank" href="https://www.openshift.com/legal/terms/" class="nav-link">Terms of use</a>
                    <a target="_blank" href="https://www.redhat.com/en/about/all-policies-guidelines" class="nav-link">All policies and guidelines</a>
                    <a id="teconsent"></a>
                </nav>
            </div>
        </div>
    </div>
</footer>
<div id="consent_blackbar" style="z-index: 100; position: fixed"></div>



<!-- Adobe DTM -->
<script type="text/javascript">
if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
   _satellite.pageBottom();
}
</script>
<!-- End Adobe DTM -->

  <!-- adjust page css based on breadcrumb and/or resize -->
  <script type="text/javascript">
    window.addEventListener('DOMContentLoaded', () => {
      if ($(window).width() >= 1008) {
        adjustSide();
        adjustToc();
        adjustMain();
      }
    });

    window.addEventListener('resize', () => {
      if ($(window).width() >= 1008) {
        adjustSide();
        adjustToc();
        adjustMain();
      } else if ($(window).width() < 1008) {
        sidebar.classList.remove('wide');
        document.querySelector('#hc-search').classList.remove('wide');
        if (sidebar.classList.contains('open')) {
          sidebar.style.display = 'block';
        } else {
          sidebar.style.display = 'none';
        }
        document.querySelector('.main').style.paddingTop = '0px';
      }
    });

    function adjustSide() {
      sidebar.classList.add('wide');
      document.querySelector('#hc-search').classList.add('wide');
      sidebar.style.display = 'block';
      document.querySelector('.sidebar').style.top = parseInt((document.querySelector('.breadcrumb').offsetHeight + 125), 10) + "px";
      document.querySelector('#hc-search').style.top = parseInt((document.querySelector('.breadcrumb').offsetHeight + 95), 10) + "px";
    }

    function adjustToc() {
      if (document.querySelector('#toc') !== null) {
        document.querySelector('#toc').style.top = parseInt((document.querySelector('.breadcrumb').offsetHeight + 90), 10) + "px";
      }
    }

    function adjustMain() {
      document.querySelector('html').style.scrollPaddingTop = parseInt((document.querySelector('.breadcrumb').offsetHeight + 90), 10) + "px";
      document.querySelector('.main').style.paddingTop = parseInt((document.querySelector('.breadcrumb').offsetHeight - 70), 10) + "px";
    }

  </script>

  <!-- remove toc active class when page is loaded -->
  <script type="text/javascript">
    window.addEventListener('DOMContentLoaded', () => {
      var tocItems = $("#toc a");

      for (let i = 0; i < tocItems.length; i++) {
        tocItems[i].classList.remove("toc-active");
      }
    })
  </script>

  <!-- maintain sidebar scroll position between page loads -->
  <script type="text/javascript">
    let sidebar = document.querySelector(".sidebar");
    let scrolltop = localStorage.getItem("sidebar-scroll");

    if (scrolltop == null) {
      sidebar.scrollTop = parseInt(top, 10);
    }

    window.addEventListener("beforeunload", () => {
      localStorage.setItem("sidebar-scroll", sidebar.scrollTop);
    });

    window.addEventListener('load', () => {
      sidebar.scrollTo(0, scrolltop)
    })
  </script>

  <!-- open/close the nav -->
  <script type="text/javascript">
    function closeNav() {
      let sidebar = document.querySelector(".sidebar");
      sidebar.style.display = "none";
      sidebar.classList.remove('open');
    }

    function openNav() {
      let sidebar = document.querySelector(".sidebar");
      let hc_search = document.querySelector('#hc-search');
      sidebar.style.display = "block";
      sidebar.style.top = "0px";
      hc_search.style.top = 'unset';
      sidebar.classList.add('open');
    }
  </script>

  <!-- clear and add toc-active to clicked toc link -->
  <script type="text/javascript">
  $("#toc a").click(function() {
    var tocItems = $("#toc a");
    for (let i = 0; i < tocItems.length; i++) {
      tocItems[i].classList.remove("toc-active");
    }
    this.classList.add("toc-active");
  });
  </script>

  <!-- update active toc class when mouse scrolls -->
  <script type="text/javascript">
    window.addEventListener('DOMContentLoaded', () => {
      window.addEventListener("wheel", () => {

        const ioConfiguration = {
          "rootMargin": "-120px 0px -400px 0px",
          "threshold": 0
        };

        const observer = new IntersectionObserver(setCurrent, ioConfiguration, entries => {
          entries.forEach(entry => {
            var id = entry.target.getAttribute('id');
            //fight with js
            document.querySelector(`#toc li a[href="#${id}"]`).classList.remove('toc-active');
          });
        });

        //track all h1-4 headings that have an id
        document.querySelectorAll('.main h2[id], .main h3[id]').forEach((h) => {
          observer.observe(h);
        });

        //runs when the IntersectionObserver fires
        function setCurrent(e) {
          var allTocLinks = document.querySelectorAll("#toc li a");
          if (allTocLinks !== undefined) {
            e.map(i => {
              if (i.isIntersecting && i.intersectionRatio >= 1) {
                allTocLinks.forEach(link => link.classList.remove("toc-active"));
                document.querySelector(`#toc li a[href="#${i.target.id}"]`).classList.add('toc-active')
              }
            })
          }
        };

        //make clicked toc item active and stop IntersectionObserver
        $("#toc a").click(function() {
          //stop tracking all h1-4 headings that have an id
          document.querySelectorAll('.main h2[id], .main h3[id]').forEach((h) => {
            observer.unobserve(h);
          });
          var tocItems = $("#toc a");
          if (tocItems !== undefined) {
            for (let i = 0; i < tocItems.length; i++) {
              tocItems[i].classList.remove("toc-active");
            };
            this.classList.add("toc-active");
          }
        })
      })
    })
  </script>

  <!--handle page scroll top and bottom, add toc-active -->
  <script type="text/javascript">
    document.addEventListener('scroll', () => {
      //scroll to bottom
      if(document.documentElement.scrollHeight === window.pageYOffset + window.innerHeight) {
        var tocItems = $("#toc a");
        for (let i = 0; i < tocItems.length; i++) {
          tocItems[i].classList.remove("toc-active")
          };
          tocItems[tocItems.length - 1].classList.add("toc-active");
        };
      //scroll to top
      if(window.pageYOffset === 0) {
        var tocItems = $("#toc a");
        for (let i = 0; i < tocItems.length; i++) {
          tocItems[i].classList.remove("toc-active");
          };
          tocItems[0].classList.add("toc-active");
        };
      })
  </script>

  <!-- adjust alerts on mobile -->
  <script type="text/javascript">
    alert = document.querySelector('#support-alert')
    window.addEventListener("wheel", () => {
      if ($(window).width() < 1008) {
        //adjust alert
        if(window.pageYOffset > 0) {
          if(alert !== null) {
            document.querySelector('#support-alert').style.position = "fixed";
            document.querySelector('#support-alert').style.bottom = "0px";
            document.querySelector('#support-alert').style.margin = "5px";
            document.querySelector('#support-alert').style.zIndex = "9999999";
          }
        }
      }
   });
    window.addEventListener('resize', () => {
      if ($(window).width() >= 1008) {
        if(alert !== null) {
          document.querySelector('#support-alert').style.removeProperty('position');
          document.querySelector('#support-alert').style.removeProperty('bottom');
          document.querySelector('#support-alert').style.removeProperty('margin');
          document.querySelector('#support-alert').style.removeProperty('zIndex');
        }
      }
    })
  </script>

  <!-- hide footer after 3 seconds -->
  <script type="text/javascript">
    const hideFooter = () => {
      document.querySelector('footer#rh, footer.footer-origin-docs').style.display = "none";
    };

    window.addEventListener('load', function() {
      setTimeout(hideFooter, 3000);
    });
  </script>
</body>
</html>